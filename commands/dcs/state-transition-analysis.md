---
description: 全面分析数据的状态转移流程
allowed-tools: Read, Glob, Grep, Task, Bash, Write
argument-hint: [目标数据名称(资源名/实体名/模型名)]
---
识别与目标数据的状态转移相关的所有功能,提供状态转移流程、相关数据的依赖关系和风险评估。

# context

输出目录=".dcs"
当前目录={{项目根目录}}
分析文件列表=[]
目标数据名称=""
状态字段名=""
检测到的状态值列表=[]

# step

- 如果没有 $1,则输出"请在参数中指定目标数据名称(例如:Order, Cart, Inventory)"并结束
- 简要说明 $1 的内容
- 使用 AskUserQuestion 工具按顺序执行以下问题,并更新 context:
  1. 确认目标数据的类型
  2. 确认状态字段名(也尝试自动检测)
  3. 确认分析范围
  4. 确认输出格式的偏好
- 向用户声明收集到的 context 内容摘要
- 执行 step2

## step2

- 确认现有输出文件,确定不重复的编号
  - 搜索 {{输出目录}}/{{timestamp}}_*.md
  - 创建将本次目标数据名称英文化的内容(例如:"order_state", "cart_status")
  - 如果存在相同 timestamp 和内容的现有文件,则将末尾的序号 +1
  - 将基础目录设为 "{{输出目录}}/{{timestamp}}_{{数据名英文化}}"
    - 例:".dcs/20251026_143000_order_state"
- 准备分析结果文件列表(按部分分割的文件)
  - 索引文件:"{{基础目录}}/index.md"
  - 摘要文件:"{{基础目录}}/summary.md"
  - 状态转移图文件:"{{基础目录}}/diagram.md"
  - 转移表文件:"{{基础目录}}/transitions.md"
  - 功能分析:"{{基础目录}}/functions.md"
  - 数据依赖关系:"{{基础目录}}/dependencies.md"
  - 风险评估:"{{基础目录}}/risks.md"
  - 推荐事项:"{{基础目录}}/recommendations.md"
- 将所有文件名添加到 分析文件列表
- 用 context 信息填充 <state_transition_analysis_template> 的内容,通过 Task 工具直接执行
  - subagent_type: "general-purpose"
  - description: "执行状态转移分析"
  - prompt: 用 context 填充模板内容的完整提示
- 接收 Task 的执行结果
- 执行 step3

## step3

- 使用 Read 确认输出的文件
- 根据 深入内容规则 判断是否需要额外调查
- 如果需要额外调查:
  - 将额外调查的内容以列表形式向用户展示
  - 获得用户的批准
  - 如果有多个额外调查项目,使用 Task 工具对每个项目单独执行额外调查
    - 对每个项目以新序号保存为额外文件(例:"_2.md", "_3.md", "_4.md")
    - 将每个文件名添加到 分析文件列表
  - 再次执行 step3(重复直到不需要额外调查,最多5次)
- 如果不需要额外调查:
  - 执行 step4

## step4

- 使用 <summary_template> 的内容,通过 Task 工具创建最终摘要文件
  - subagent_type: "general-purpose"
  - description: "状态转移分析 最终摘要的创建"
  - prompt: 用 context 填充摘要模板内容的完整提示
  - 最终摘要文件名:"{{基础目录}}/final_summary.md"
- 按分析次数整理显示所有分析文件的路径
  - 初次分析文件列表(索引、摘要、转移图等)
  - 额外调查文件列表(如适用)
  - 最终摘要
- 向用户报告分析完成

# rules

## 确认要点

使用 AskUserQuestion 工具按顺序执行以下问题:

### 问题1: 目标数据的类型
- **问题**: 目标数据是什么类型?
- **header**: "数据类型"
- **options**:
  - "Prismatix 资源" - 在YAML中定义的资源(prismatix-factory/resources/)
  - "Kotlin实体" - 后端的实体类
  - "TypeScript类型" - 前端的类型定义
  - "自然语言" - 概念数据(具体实现未指定)

### 问题2: 状态字段名
- **问题**: 表示状态的字段名是什么?(如果不知道,请选择"自动检测")
- **header**: "状态字段"
- **options**:
  - "status" - 通用的 status 字段
  - "state" - state 字段
  - "orderStatus" - 订单状态
  - "自动检测" - 尝试从代码中自动检测

### 问题3: 分析范围
- **问题**: 要分析到哪个范围?
- **header**: "分析范围"
- **multiSelect**: true
- **options**:
  - "后端" - Kotlin Spring Boot的代码
  - "前端" - React/Next.js的代码
  - "BFF" - Next.js API routes
  - "拦截器" - Prismatix Factory的拦截器

### 问题4: 输出格式
- **问题**: 希望使用哪种输出格式?
- **header**: "输出格式"
- **multiSelect**: true
- **options**:
  - "Mermaid图" - 以Mermaid格式输出状态转移图
  - "转移表" - 以表格格式输出状态转移
  - "流程详细" - 每个转移的详细说明
  - "风险评估" - 伴随状态转移的风险评估

作为context保持以下内容
- 目标数据名称
- 数据类型
- 状态字段名
- 分析范围
- 输出格式

## 文件名规则

### timestamp 格式
- yyyyMMddHHmmss 格式(例:20251026143000)

### 数据名英文化规则
- 将目标数据名称转换为简洁的英文,并添加表示状态的后缀
- 使用蛇形命名法(snake_case)
- 限制在30个字符以内
- 例:
  - "Order" → "order_state"
  - "Cart" → "cart_status"
  - "库存" → "inventory_state"
  - "支付" → "payment_status"

### 分部分文件名规则
- 分析结果按逻辑部分分割,每个部分目标在500行以内
- 部分列表:
  - `index.md` - 索引(整体概要和文件列表)
  - `summary.md` - 分析对象和摘要
  - `diagram.md` - 状态转移图(Mermaid格式)
  - `transitions.md` - 状态转移表
  - `functions.md` - 按功能的状态转移分析
  - `dependencies.md` - 与其他数据的依赖关系
  - `risks.md` - 风险评估
  - `recommendations.md` - 推荐事项

## 文件路径的记载规则

- **使用基于当前目录的相对路径**
- 不记载完整路径(绝对路径)
- 例:
  - ❌ `/Users/makotan/projects/ensemble-si/backend/src/main/kotlin/...`
  - ✅ `backend/src/main/kotlin/...`

## 状态转移分析的观点

### 1. 状态值的特定
- 列举所有可能的状态值
- 确认enum定义、常量定义、YAML中的定义
- 还检测代码中以字符串字面量使用的状态值

### 2. 转移模式的分类
- **正常转移**: 按照业务流程的通常转移
- **异常转移**: 错误或取消等异常转移
- **修正转移**: 管理员手动修正等
- **自动转移**: 批处理或调度器的转移

### 3. 转移触发的特定
- API端点调用
- 拦截器的自动执行
- 批处理
- 外部系统通知
- 超时等基于时间

### 4. 转移条件的分析
- 状态转移的前提条件(从哪个状态可以转移到哪个状态)
- 业务规则的约束
- 相关数据的状态依赖
- 权限检查

### 5. 副作用的特定
- 伴随状态转移的其他数据变更
- 通知的发送(邮件、推送通知等)
- 与外部系统的联动
- 日志记录

## 风险评估标准

从以下观点评估风险:

### 状态的复杂度
- 状态数量多: 风险增加
- 转移模式复杂: 风险增加
- 存在循环转移: 需要注意

### 数据一致性
- 多个数据的状态联动: 高风险
- 事务边界不明确: 高风险
- 回滚处理未实现: 高风险

### 错误处理
- 异常系统的转移未定义: 高风险
- 重试处理不当: 中风险
- 错误通知不足: 中风险

### 可测试性
- 状态转移的测试不足: 中风险
- 边缘案例的测试缺失: 高风险

## 需要额外调查的条件

如果符合以下任一条件,建议额外调查:

- 状态数量在10个以上
- 检测到循环转移模式
- 多个数据的状态密切联动
- 与外部系统的联动
- 事务边界不明确
- 错误处理不充分
- 测试覆盖率低
- 文档与实现可能存在偏差

## 深入内容规则

根据调查的内容,列出以下观点需要额外调查的部分:

- 复杂转移模式的详细分析
- 数据一致性的验证方法
- 错误处理的改进点
- 测试用例的缺失部分
- 对性能的影响
- 安全性问题

# info

<state_transition_analysis_template>
您是状态转移分析专家。请根据以下信息,全面分析目标数据的状态转移,按部分分割并输出文件。

# 分析对象的信息

目标数据名称: {{目标数据名称}}
数据类型: {{数据类型}}
状态字段名: {{状态字段名}}
分析范围: {{分析范围}}
输出格式: {{输出格式}}
基础目录: {{基础目录}}(例:".dcs/20251026143000_order_state")
当前目录: {{当前目录}}

# 重要注意事项

**所有文件路径应使用基于当前目录的相对路径。**
**不要使用绝对路径(/Users/... 等)。**
**每个部分文件目标在500行以内。**

# 输出文件构成

分析结果按以下部分文件分割输出:

1. **索引文件**: `{{基础目录}}/index.md`
   - 整体概要和所有部分文件的链接

2. **摘要文件**: `{{基础目录}}/summary.md`
   - 分析对象、摘要、风险评估

3. **状态转移图文件**: `{{基础目录}}/diagram.md`
   - Mermaid格式的状态转移图

4. **转移表文件**: `{{基础目录}}/transitions.md`
   - 详细的状态转移表

5. **功能分析文件**: `{{基础目录}}/functions.md`
   - 各功能执行的状态转移详情

6. **数据依赖关系文件**: `{{基础目录}}/dependencies.md`
   - 与其他数据的状态依赖关系

7. **风险评估文件**: `{{基础目录}}/risks.md`
   - 关于状态转移的风险评估详情

8. **推荐事项文件**: `{{基础目录}}/recommendations.md`
   - 改进建议和推荐行动

# 分析步骤

## 1. 目标数据的特定和状态字段的确认

### 1.1 数据定义的特定
- 根据数据类型搜索定义位置
  - Prismatix资源: `prismatix-factory/resources/{{目标数据名称}}.yaml`
  - Kotlin实体: `backend/src/main/kotlin/**/entity/**/*{{目标数据名称}}*.kt`
  - TypeScript类型: `frontend/src/**/*{{目标数据名称}}*.ts` 或 `admin/src/**/*{{目标数据名称}}*.ts`
- 使用 Read 工具读取定义文件

### 1.2 状态字段的确认
- 确认指定的状态字段名
- 在"自动检测"的情况下,使用以下模式搜索:
  - `status`, `state`, `{{数据名}}Status`, `{{数据名}}State`
  - 搜索enum定义: `enum.*Status`, `enum.*State`
- 特定状态字段的类型(enum, string, number等)

### 1.3 状态值的列举
- 从enum定义提取状态值
- 从YAML定义提取可能的值
- 使用 Grep 搜索代码中使用的状态值
  - 字符串字面量: `"PENDING"`, `"COMPLETED"` 等
  - 常量引用: `OrderStatus.PENDING` 等
- 列出检测到的所有状态值

## 2. 搜索执行状态转移的功能

### 2.1 后端搜索(如果包含在分析范围内)
- **控制器**: 更新状态的API端点
  - Grep: `@PutMapping.*{{目标数据名称}}`, `@PostMapping.*{{目标数据名称}}`
  - 搜索对状态字段的赋值: `\.{{状态字段名}}\s*=`
- **服务类**: 业务逻辑内的状态更新
  - Grep: `class.*Service`, `fun.*update`, `fun.*change`
- **拦截器**: 自动状态更新
  - Grep: `Interceptor`, `@Component.*Interceptor`
  - 特别是 `Before`, `After`, `Around` 系列拦截器
- **批处理**: 调度器的状态更新
  - Grep: `@Scheduled`, `@EnableScheduling`

### 2.2 前端搜索(如果包含在分析范围内)
- **API调用**: 更改状态的API调用
  - Grep: `api.*{{目标数据名称}}`, `fetch.*{{目标数据名称}}`
  - 特定 `PUT`, `POST`, `PATCH` 方法
- **状态管理**: 客户端状态管理
  - Grep: `useState`, `useReducer`, `{{目标数据名称}}Context`

### 2.3 BFF搜索(如果包含在分析范围内)
- **API Routes**: Next.js API routes的状态更新
  - Glob: `frontend/src/pages/api/**/*.ts`, `admin/src/pages/api/**/*.ts`
  - Grep: `{{目标数据名称}}`, 状态字段名

## 3. 各功能的状态转移模式分析

对每个检测到的功能,分析以下内容:

### 3.1 转移源・转移目标的特定
- 使用 Read 详细确认更改状态的代码
- 特定从哪个状态转移到哪个状态
  - 确认条件分支(if, when, switch)
  - 提取状态检查的逻辑
- 记录可以转移的状态组合

### 3.2 转移条件的提取
- 特定状态转移的前提条件
  - 当前状态的检查
  - 业务规则的验证
  - 相关数据的状态确认
  - 权限检查
- 记录条件表达式和验证逻辑

### 3.3 转移触发的分类
- API端点调用 → 端点URL和HTTP方法
- 拦截器 → 触发事件(Before/After/Around)
- 批处理 → 执行计划(cron表达式等)
- 外部联动 → 外部系统名称和联动方法

### 3.4 副作用的特定
- 提取状态转移时执行的处理
  - 其他数据的更新
  - 通知的发送(邮件、推送通知等)
  - 日志记录
  - 事件发布
  - 与外部系统的联动

## 4. 数据依赖关系的分析

### 4.1 相关数据的特定
- 特定通过外键相关的数据
  - YAML定义的 relations 部分
  - Kotlin实体的 `@ManyToOne`, `@OneToMany` 等
- 使用 Grep 搜索对相关数据的引用

### 4.2 状态联动模式
- 分析目标数据的状态变更对其他数据的影响
- 分析其他数据的状态变更对目标数据的影响
- 例:
  - Order.status 变为 "COMPLETED" 时 OrderItem.status 也联动
  - Payment.status 变为 "PAID" 时 Order.status 被更新

### 4.3 事务边界的确认
- 确认状态更新是否在事务内执行
- `@Transactional` 注解的有无
- 确认多个数据的状态更新是否在同一事务

## 5. 风险评估

根据以下标准评估风险:

### 5.1 状态的复杂度
- 状态数: 越多风险越大(10个以上: 高风险)
- 转移模式数: 越复杂风险越大
- 循环转移: 存在时需要注意

### 5.2 数据一致性风险
- 多个数据的状态联动: 联动越多风险越高
- 事务边界: 不明确时高风险
- 回滚处理: 未实现时高风险

### 5.3 错误处理
- 异常系统的转移定义: 不足时高风险
- 错误时的重试: 不当时中风险
- 错误通知: 不足时中风险

### 5.4 可测试性
- 状态转移的测试用例: 不足时中〜高风险
- 边缘案例的覆盖率: 低时高风险

## 6. 按部分文件输出

按以下顺序创建各部分文件。**使用 Write 工具单独保存每个文件。**

### 6.1 索引文件的创建
`{{基础目录}}/index.md`

```markdown
# 状态转移分析 - 索引

**实施日期**: {{实施日期}}
**分析者**: Claude Code

---

## 分析概要

### 目标数据
- **数据名称**: {{目标数据名称}}
- **状态字段**: {{状态字段名}}
- **状态数**: XX个
- **转移模式数**: XX个

### 摘要

| 项目 | 内容 |
|------|------|
| 综合风险评估 | **高/中/低** |
| 检测到的功能数 | XX个 |
| 数据依赖关系 | XX个 |

---

## 分析结果文件列表

### 基本信息
- [摘要](./summary.md) - 分析结果概要

### 状态转移详情
- [状态转移图](./diagram.md) - Mermaid格式可视化
- [转移表](./transitions.md) - 详细转移表

### 功能和数据
- [功能分析](./functions.md) - 各功能的状态转移
- [数据依赖关系](./dependencies.md) - 与相关数据的依赖

### 评估和推荐
- [风险评估](./risks.md) - 风险评估详情
- [推荐事项](./recommendations.md) - 改进建议

---

## 快速导航

### 高风险项目
1. {{高风险项目1}} - [详情](./risks.md)
2. {{高风险项目2}} - [详情](./risks.md)

### 复杂的转移模式
1. {{复杂模式1}} - [详情](./transitions.md)
2. {{复杂模式2}} - [详情](./transitions.md)

---

*各文件详情请参考上述链接。*
```

### 6.2 摘要文件的创建
`{{基础目录}}/summary.md`

```markdown
# 状态转移分析 - 摘要

**实施日期**: {{实施日期}}
**分析者**: Claude Code

[← 返回索引](./index.md)

---

## 分析对象

### 目标数据
- **数据名称**: {{目标数据名称}}
- **数据类型**: {{数据类型}}
- **状态字段**: {{状态字段名}}
- **状态字段类型**: {{类型信息}}

### 分析范围
- {{分析范围1}}
- {{分析范围2}}

---

## 状态值列表

检测到的状态值(XX个):

| 状态值 | 说明 | 定义位置 |
|-------|------|----------|
| {{状态1}} | {{说明}} | {{相对路径:行号}} |
| {{状态2}} | {{说明}} | {{相对路径:行号}} |
| ... | ... | ... |

---

## 分析结果摘要

| 项目 | 内容 |
|------|------|
| 检测到的状态数 | XX个 |
| 转移模式数 | XX个 |
| 执行状态转移的功能数 | XX个 |
| 数据依赖关系数 | XX个 |
| 综合风险评估 | **高/中/低** |

### 风险评估依据
{{简要描述综合风险评估的理由}}

---

## 转移模式的分类

| 分类 | 数量 | 备注 |
|------|------|------|
| 正常转移 | XX件 | 按照业务流程的转移 |
| 异常转移 | XX件 | 错误或取消 |
| 修正转移 | XX件 | 管理员手动修正 |
| 自动转移 | XX件 | 批处理等 |

---

## 功能分类

| 功能类型 | 数量 | 主要文件 |
|---------|------|-------------|
| 控制器 | XX件 | [详情](./functions.md) |
| 服务 | XX件 | [详情](./functions.md) |
| 拦截器 | XX件 | [详情](./functions.md) |
| 批处理 | XX件 | [详情](./functions.md) |

---

## 主要发现事项

1. **{{发现事项1}}**
   - {{详情}}
   - 风险: 高/中/低

2. **{{发现事项2}}**
   - {{详情}}
   - 风险: 高/中/低

3. **{{发现事项3}}**
   - {{详情}}
   - 风险: 高/中/低

---

## 需要额外调查的项目

建议对以下项目进行额外调查:

1. {{额外调查项目1}}
2. {{额外调查项目2}}
3. {{额外调查项目3}}

(如果不需要额外调查,记载"无")

---

*详细分析结果请参考各部分文件。*
```

### 6.3 状态转移图文件的创建
`{{基础目录}}/diagram.md`

```markdown
# 状态转移分析 - 状态转移图

**实施日期**: {{实施日期}}
**分析者**: Claude Code

[← 返回索引](./index.md) | [摘要](./summary.md)

---

## 状态转移图(Mermaid)

### 整体状态转移

\```mermaid
stateDiagram-v2
    [*] --> {{初始状态}}

    {{初始状态}} --> {{状态A}} : {{转移条件A}}
    {{状态A}} --> {{状态B}} : {{转移条件B}}
    {{状态B}} --> {{状态C}} : {{转移条件C}}
    {{状态C}} --> [*]

    {{状态A}} --> {{错误状态}} : 发生错误
    {{状态B}} --> {{错误状态}} : 发生错误

    note right of {{状态A}}
        {{状态A的说明}}
    end note
\```

### 正常流程的转移

\```mermaid
stateDiagram-v2
    {{正常流程的状态转移图}}
\```

### 异常流程的转移

\```mermaid
stateDiagram-v2
    {{异常流程的状态转移图}}
\```

---

## 转移模式图例

| 模式 | 说明 | 触发示例 |
|---------|------|-----------|
| A → B | {{模式说明}} | {{触发}} |
| B → C | {{模式说明}} | {{触发}} |
| X → 错误 | {{模式说明}} | {{触发}} |

---

## 循环转移的注意点

(如果存在循环转移)

检测到以下循环转移模式:

1. **{{循环模式1}}**: A → B → C → A
   - 风险: {{风险等级}}
   - 注意事项: {{注意事项}}

---

*转移详情请参考转移表文件。*
```

### 6.4 转移表文件的创建
`{{基础目录}}/transitions.md`

```markdown
# 状态转移分析 - 转移表

**实施日期**: {{实施日期}}
**分析者**: Claude Code

[← 返回索引](./index.md) | [摘要](./summary.md)

---

## 状态转移表(整体)

| 转移ID | 转移源 | 转移目标 | 转移条件 | 触发 | 功能 | 风险 |
|-------|--------|--------|---------|---------|------|-------|
| T001 | {{状态A}} | {{状态B}} | {{条件}} | {{触发}} | [详情](./functions.md#func1) | 低 |
| T002 | {{状态B}} | {{状态C}} | {{条件}} | {{触发}} | [详情](./functions.md#func2) | 中 |
| ... | ... | ... | ... | ... | ... | ... |

---

## 按状态的转移详情

### 从 {{状态A}} 的转移

#### {{状态A}} → {{状态B}}
- **转移ID**: T001
- **转移条件**:
  - {{条件1}}
  - {{条件2}}
- **触发**: {{触发详情}}
- **实现位置**: [{{相对路径}}]({{相对路径}}#L{{行号}})
- **副作用**:
  - {{副作用1}}
  - {{副作用2}}
- **相关数据的状态变更**:
  - {{数据X}}.{{状态字段}} 变更为 {{新状态}}
- **风险**: 低/中/高
- **风险原因**: {{理由}}

#### {{状态A}} → {{错误状态}}
(以同样格式描述)

---

### 从 {{状态B}} 的转移

(以同样格式描述各状态的转移)

---

## 按转移模式的详情

### 正常转移模式

(详细描述正常流程的转移)

### 异常转移模式

(详细描述异常流程的转移)

### 修正转移模式

(描述管理员手动修正等的转移)

---

## 不可能的转移模式

以下转移在实现上不可能:

| 转移源 | 转移目标 | 理由 |
|-------|--------|------|
| {{状态X}} | {{状态Y}} | {{不可能的理由}} |

---

*各功能详情请参考功能分析文件。*
```

### 6.5 功能分析文件的创建
`{{基础目录}}/functions.md`

```markdown
# 状态转移分析 - 功能分析

**实施日期**: {{实施日期}}
**分析者**: Claude Code

[← 返回索引](./index.md) | [摘要](./summary.md)

---

## 控制器层

### <a name="func1"></a>[相对路径:行号](相对路径#L行号)

- **功能名**: {{功能名}}
- **端点**: `{{HTTP方法}} {{URL}}`
- **执行的状态转移**:
  - {{状态A}} → {{状态B}}
  - {{状态B}} → {{状态C}}
- **转移条件**:
  - {{条件1}}
  - {{条件2}}
- **副作用**:
  - {{副作用1}}
  - {{副作用2}}
- **事务**: 有/无
- **错误处理**: {{错误处理说明}}
- **测试用例**: {{测试的有无和位置}}
- **风险**: 低/中/高
- **备注**: {{其他注意事项}}

---

## 服务层

### [相对路径:行号](相对路径#L行号)

(以同样格式描述)

---

## 拦截器

### [相对路径:行号](相对路径#L行号)

- **拦截器名**: {{名称}}
- **触发**: Before/After/Around {{事件名}}
- **执行的状态转移**:
  - {{状态X}} → {{状态Y}}
- **转移条件**:
  - {{条件}}
- **自动执行**: 是/否
- **副作用**:
  - {{副作用}}
- **错误处理**: {{错误处理}}
- **风险**: 低/中/高
- **备注**: {{注意事项}}

---

## 批处理

### [相对路径:行号](相对路径#L行号)

- **批处理名**: {{名称}}
- **执行计划**: {{cron表达式}}
- **执行的状态转移**:
  - {{状态P}} → {{状态Q}}
- **目标数据的提取条件**:
  - {{条件}}
- **副作用**:
  - {{副作用}}
- **错误处理**: {{错误处理}}
- **重试处理**: 有/无
- **风险**: 低/中/高
- **备注**: {{注意事项}}

---

## BFF(Backend for Frontend)

### [相对路径:行号](相对路径#L行号)

- **API Route**: `{{HTTP方法}} {{路径}}`
- **调用的 Backend API**: {{后端API}}
- **执行的状态转移**:
  - {{状态M}} → {{状态N}}
- **前端显示**: {{UI上的变化}}
- **错误处理**: {{错误处理}}
- **风险**: 低/中/高

---

*各功能执行的转移详情请参考转移表文件。*
```

### 6.6 数据依赖关系文件的创建
`{{基础目录}}/dependencies.md`

```markdown
# 状态转移分析 - 数据依赖关系

**实施日期**: {{实施日期}}
**分析者**: Claude Code

[← 返回索引](./index.md) | [摘要](./summary.md)

---

## 相关数据列表

| 数据名 | 关系类型 | 状态字段 | 依赖方向 |
|---------|---------|--------------|---------|
| {{数据A}} | 1:N | {{statusField}} | 双向 |
| {{数据B}} | N:1 | {{stateField}} | 单向 |
| ... | ... | ... | ... |

---

## 状态联动模式

### {{目标数据}} → {{数据A}} 的影响

#### 当 {{目标数据}}.{{状态}} 变为 {{状态值}} 时

- **对{{数据A}}的影响**:
  - {{数据A}}.{{状态字段}} 变更为 {{新状态}}
  - 实现位置: [{{相对路径}}]({{相对路径}}#L{{行号}})
  - 事务边界: {{同一事务/不同事务}}
- **业务规则**:
  - {{规则说明}}
- **错误情况**:
  - {{错误时的动作}}
- **风险**: 低/中/高
- **风险原因**: {{理由}}

### {{数据B}} → {{目标数据}} 的影响

#### 当 {{数据B}}.{{状态}} 变为 {{状态值}} 时

(以同样格式描述)

---

## 复合状态依赖

### 模式1: {{复合模式名}}

- **相关数据**:
  - {{目标数据}}
  - {{数据A}}
  - {{数据B}}
- **状态联动流程**:
  1. {{数据B}}.{{状态}} 变为 {{状态1}}
  2. {{目标数据}}.{{状态}} 变更为 {{状态2}}
  3. {{数据A}}.{{状态}} 变更为 {{状态3}}
- **实现位置**:
  - [{{相对路径1}}]({{相对路径1}}#L{{行号}})
  - [{{相对路径2}}]({{相对路径2}}#L{{行号}})
- **事务边界**: {{说明}}
- **一致性风险**: 低/中/高
- **风险原因**: {{理由}}

---

## 事务边界分析

### 同一事务内的状态更新

以下数据在同一事务内更新状态:

1. **{{事务1}}**:
   - 更新的数据: {{目标数据}}, {{数据A}}
   - 实现位置: [{{相对路径}}]({{相对路径}}#L{{行号}})
   - `@Transactional` 的有无: 有/无
   - 风险: 低/中/高

### 不同事务的状态更新

以下数据在不同事务中更新状态:

1. **{{数据组合}}**:
   - 数据1: {{目标数据}} (事务 A)
   - 数据2: {{数据B}} (事务 B)
   - 一致性风险: 高
   - 风险原因: {{理由}}
   - 推荐对应: {{对应方法}}

---

## 与外部系统的联动

### {{外部系统名}}

- **联动时机**: 当 {{目标数据}}.{{状态}} 变为 {{状态值}} 时
- **联动内容**: {{内容}}
- **实现位置**: [{{相对路径}}]({{相对路径}}#L{{行号}})
- **错误处理**: {{错误时的动作}}
- **重试处理**: 有/无
- **风险**: 低/中/高

---

## 数据一致性风险

### 高风险项目

1. **{{风险项目1}}**:
   - 风险内容: {{说明}}
   - 影响范围: {{影响}}
   - 推荐对应: {{对应方法}}

2. **{{风险项目2}}**:
   (以同样格式描述)

---

*与依赖关系相关的风险评估请参考风险评估文件。*
```

### 6.7 风险评估文件的创建
`{{基础目录}}/risks.md`

```markdown
# 状态转移分析 - 风险评估

**实施日期**: {{实施日期}}
**分析者**: Claude Code

[← 返回索引](./index.md) | [摘要](./summary.md)

---

## 综合风险评估

| 项目 | 评估 | 理由 |
|------|------|------|
| 状态复杂度 | 高/中/低 | {{理由}} |
| 数据一致性 | 高/中/低 | {{理由}} |
| 错误处理 | 高/中/低 | {{理由}} |
| 可测试性 | 高/中/低 | {{理由}} |
| **综合评估** | **高/中/低** | {{综合理由}} |

---

## 状态复杂度风险

### 状态数
- **检测到的状态数**: XX个
- **评估**: 高/中/低
- **理由**: {{评估理由}}

### 转移模式数
- **检测到的转移模式数**: XX个
- **评估**: 高/中/低
- **理由**: {{评估理由}}

### 循环转移
- **循环转移的有无**: 有/无
- **循环模式**: {{模式说明}}
- **评估**: 高/中/低
- **理由**: {{评估理由}}

---

## 数据一致性风险

### 多个数据的状态联动

| 联动模式 | 相关数据数 | 事务 | 风险 |
|-------------|------------|----------------|-------|
| {{模式1}} | X个 | 同一/不同 | 高/中/低 |
| {{模式2}} | X个 | 同一/不同 | 高/中/低 |

#### 高风险项目详情

1. **{{联动模式名}}**:
   - 风险内容: {{说明}}
   - 影响范围: {{影响}}
   - 发生条件: {{条件}}
   - 推荐对应: {{对应方法}}

### 事务边界问题

- **不明确的事务边界**: XX处
- **评估**: 高/中/低
- **具体例**:
  - [{{相对路径}}]({{相对路径}}#L{{行号}})
  - 问题点: {{问题说明}}

### 回滚处理

- **回滚处理的实现**: 有/无/部分
- **评估**: 高/中/低
- **未实现位置**:
  - [{{相对路径}}]({{相对路径}}#L{{行号}})

---

## 错误处理风险

### 异常系统的转移定义

- **已定义异常转移**: XX个
- **可能未定义的异常转移**: XX个
- **评估**: 高/中/低

#### 未定义的异常转移

1. **当 {{状态A}} 发生错误时**:
   - 现状: {{现状动作}}
   - 问题点: {{问题}}
   - 推荐对应: {{对应方法}}

### 重试处理

- **重试处理的实现**: 有/无/部分
- **评估**: 高/中/低
- **问题位置**:
  - [{{相对路径}}]({{相对路径}}#L{{行号}})
  - 问题点: {{问题说明}}

### 错误通知

- **错误通知的实现**: 有/无/部分
- **评估**: 高/中/低
- **不足位置**:
  - {{位置说明}}

---

## 可测试性风险

### 状态转移的测试覆盖率

- **已测试的转移模式**: XX / YY 个 (XX%)
- **评估**: 高/中/低

#### 未测试的转移

| 转移源 | 转移目标 | 功能 | 风险 |
|-------|--------|------|-------|
| {{状态A}} | {{状态B}} | [详情](./functions.md#func1) | 高/中/低 |

### 边缘案例的测试

- **边缘案例的测试**: 有/无/部分
- **评估**: 高/中/低
- **未测试的边缘案例**:
  1. {{边缘案例1}}
  2. {{边缘案例2}}

---

## 安全风险

### 权限检查

- **权限检查的实现**: 有/无/部分
- **评估**: 高/中/低
- **不足位置**:
  - [{{相对路径}}]({{相对路径}}#L{{行号}})
  - 问题点: {{问题说明}}

### 状态转移的非法操作

- **非法操作的防止**: 有/无/部分
- **评估**: 高/中/低
- **漏洞可能性**:
  - {{漏洞说明}}

---

## 性能风险

### 高频执行的转移

| 转移 | 执行频率 | 性能影响 | 风险 |
|------|---------|------------------|-------|
| {{转移1}} | 高 | {{影响}} | 高/中/低 |

### 数据库锁定

- **锁定的发生可能性**: 有/无
- **评估**: 高/中/低
- **风险位置**:
  - [{{相对路径}}]({{相对路径}}#L{{行号}})

---

## 风险优先级

### 需要立即对应(高风险)

1. **{{风险项目1}}**:
   - 风险等级: 高
   - 影响范围: {{影响}}
   - 推荐对应: {{对应方法}}
   - 所需时间: {{概算}}

2. **{{风险项目2}}**:
   (以同样格式描述)

### 需要审查和验证(中风险)

1. **{{风险项目}}**:
   - 风险等级: 中
   - 影响范围: {{影响}}
   - 推荐对应: {{对应方法}}

### 建议确认(低风险)

1. **{{风险项目}}**:
   - 风险等级: 低
   - 推荐对应: {{对应方法}}

---

*风险的对应方法请参考推荐事项文件。*
```

### 6.8 推荐事项文件的创建
`{{基础目录}}/recommendations.md`

```markdown
# 状态转移分析 - 推荐事项

**实施日期**: {{实施日期}}
**分析者**: Claude Code

[← 返回索引](./index.md) | [摘要](./summary.md)

---

## 优先级: 高(需要立即对应)

### 1. {{推荐事项1}}

- **对象位置**: [{{相对路径}}]({{相对路径}}#L{{行号}})
- **现状问题**: {{问题说明}}
- **推荐对应**:
  1. {{对应步骤1}}
  2. {{对应步骤2}}
  3. {{对应步骤3}}
- **预期效果**: {{效果}}
- **所需时间**: {{概算}}
- **相关风险**: [{{风险名}}](./risks.md)

### 2. {{推荐事项2}}

(以同样格式描述)

---

## 优先级: 中(需要审查和验证)

### 1. {{推荐事项}}

- **对象位置**: [{{相对路径}}]({{相对路径}}#L{{行号}})
- **现状问题**: {{问题说明}}
- **推荐对应**: {{对应方法}}
- **预期效果**: {{效果}}
- **相关风险**: [{{风险名}}](./risks.md)

---

## 优先级: 低(建议确认)

### 1. {{推荐事项}}

- **对象位置**: [{{相对路径}}]({{相对路径}}#L{{行号}})
- **推荐对应**: {{对应方法}}

---

## 测试强化推荐

### 单元测试

**应该添加的测试用例**:

1. **{{测试用例1}}**:
   - 测试内容: {{内容}}
   - 对象功能: [{{功能名}}](./functions.md#func1)
   - 优先级: 高/中/低

2. **{{测试用例2}}**:
   (以同样格式描述)

### 集成测试

**应该添加的测试场景**:

1. **{{场景1}}**:
   - 场景: {{说明}}
   - 验证的转移: {{转移模式}}
   - 优先级: 高/中/低

### E2E测试

**应该添加的用户场景**:

1. **{{场景1}}**:
   - 用户故事: {{说明}}
   - 验证的状态转移: {{转移流程}}
   - 优先级: 高/中/低

---

## 文档整备推荐

### 状态转移规格书

- **现状**: {{现状文档情况}}
- **推荐内容**:
  - 创建状态转移图(参考本分析结果)
  - 明文化各转移的条件和业务规则
  - 定义错误情况
- **使用者**: 开发者、QA工程师、产品负责人

### API规格书

- **现状**: {{现状规格书}}
- **推荐内容**:
  - 明确执行状态转移的API端点
  - 记载可以转移的状态组合
  - 详细化错误响应

---

## 代码改进推荐

### 重构

1. **{{重构项目1}}**:
   - 对象: [{{相对路径}}]({{相对路径}}#L{{行号}})
   - 问题点: {{问题}}
   - 推荐改进: {{改进方法}}
   - 优点: {{优点}}

### 设计模式的应用

1. **State 模式的应用**:
   - 对象: {{对象位置}}
   - 理由: {{应用理由}}
   - 预期效果: {{效果}}

---

## 监控和告警推荐

### 状态转移的监控

- **推荐指标**:
  1. 各状态的停留时间
  2. 转移的成功率/失败率
  3. 异常转移的发生频率
- **实现方法**: {{实现建议}}

### 告警设置

- **推荐告警**:
  1. {{告警1}}: {{条件和通知对象}}
  2. {{告警2}}: {{条件和通知对象}}

---

## 错误处理改进推荐

### 添加重试处理

- **对象位置**: [{{相对路径}}]({{相对路径}}#L{{行号}})
- **推荐重试策略**:
  - 最大重试次数: {{次数}}
  - 重试间隔: {{间隔}}
  - 重试对象错误: {{错误类型}}

### 改进错误通知

- **对象位置**: {{位置}}
- **推荐通知方法**: {{方法}}
- **通知内容**: {{内容}}

---

## 安全强化推荐

### 添加权限检查

- **对象位置**: [{{相对路径}}]({{相对路径}}#L{{行号}})
- **推荐检查内容**:
  - {{检查项目1}}
  - {{检查项目2}}

### 添加审计日志

- **对象转移**: {{转移}}
- **应该记录的信息**:
  - {{信息1}}
  - {{信息2}}

---

## 数据一致性改进推荐

### 明确事务边界

- **对象位置**: [{{相对路径}}]({{相对路径}}#L{{行号}})
- **推荐对应**: {{对应方法}}

### 添加一致性检查

- **对象数据**: {{数据名}}
- **推荐检查内容**:
  - {{检查项目1}}
  - {{检查项目2}}

---

## 其他推荐事项

1. **{{其他推荐1}}**:
   - 内容: {{说明}}
   - 预期效果: {{效果}}

2. **{{其他推荐2}}**:
   (以同样格式描述)

---

*各推荐事项的详细风险评估请参考风险评估文件。*
```

## 7. 分析注意点

- 动态状态变更(反射等)可能无法检测
- 通过字符串的间接状态更新检测困难
- 排除注释掉的代码
- 将测试代码作为参考信息包含
- **所有文件路径使用相对路径记载(不使用绝对路径)**
- **各部分文件目标在500行以内**

## 8. 输出步骤

**重要**: 必须按以下顺序创建文件:

1. **首先创建索引文件** (`{{基础目录}}/index.md`)
2. **创建摘要文件** (`{{基础目录}}/summary.md`)
3. **创建状态转移图文件** (`{{基础目录}}/diagram.md`)
4. **创建转移表文件** (`{{基础目录}}/transitions.md`)
5. **创建功能分析文件** (`{{基础目录}}/functions.md`)
6. **创建数据依赖关系文件** (`{{基础目录}}/dependencies.md`)
7. **创建风险评估文件** (`{{基础目录}}/risks.md`)
8. **创建推荐事项文件** (`{{基础目录}}/recommendations.md`)

**使用 Write 工具单独保存每个文件。不要合并到一个文件中。**
</state_transition_analysis_template>

<summary_template>
您是状态转移分析摘要创建专家。请根据以下信息创建最终摘要。

# 摘要创建对象的信息

目标数据名称: {{目标数据名称}}
分析文件列表: {{分析文件列表}}
最终摘要文件名: {{摘要文件名}}(例:".dcs/20251026143000_order_state/final_summary.md")
当前目录: {{当前目录}}

# 重要注意事项

**所有文件路径应使用基于当前目录的相对路径。**
**不要使用绝对路径(/Users/... 等)。**
**此文件应在500行以内简洁描述。**

# 摘要创建步骤

## 1. 读取所有分析文件

- 使用 Read 读取 {{分析文件列表}} 中包含的所有文件
- 掌握各文件的内容

## 2. 信息整合

- 从所有分析结果整合以下信息
  - 检测到的状态值总数
  - 转移模式总数
  - 功能总数
  - 数据依赖关系总数
  - 综合风险评估(最高风险等级)

## 3. 提取要点

- 突出最重要的发现
- 强调特别需要注意的部分
- 记载额外调查发现的重要事项

## 4. 创建整合推荐行动

- 从全部分析结果提取高优先级的行动
- 消除重复,设置优先级
- 提出整体改进方针

## 5. 输出摘要文件

请使用以下输出格式将结果保存到 {{摘要文件名}}。

# 输出格式

```markdown
# 状态转移分析 - 最终摘要

**实施日期**: {{实施日期}}
**分析者**: Claude Code

---

## 导航

- [初次分析索引](./index.md)
- [初次分析摘要](./summary.md)

(如果有额外调查则添加)
- [额外调查2索引](./{base_filename}_2/index.md)
- [额外调查3索引](./{base_filename}_3/index.md)

---

## 分析概要

### 目标数据
- **数据名称**: {{目标数据名称}}
- **状态字段**: {{状态字段名}}
- **数据类型**: {{数据类型}}

### 分析实施情况
- **实施的分析次数**: {{分析次数}}次(初次 + 额外调查{{N}}次)
- **创建的文件数**: {{文件数}}件

---

## 综合摘要

| 项目 | 内容 |
|------|------|
| 检测到的状态数 | XX个 |
| 转移模式数 | XX个 |
| 功能数 | XX个 |
| 数据依赖关系数 | XX个 |
| 综合风险评估 | **高/中/低** |

### 综合风险评估依据
{{描述整体风险评估的理由}}

---

## 状态转移的整体像

### 状态值列表

| 状态值 | 说明 | 作为转移源的次数 | 作为转移目标的次数 |
|-------|------|----------------|----------------|
| {{状态1}} | {{说明}} | XX次 | XX次 |
| {{状态2}} | {{说明}} | XX次 | XX次 |
| ... | ... | ... | ... |

### 转移模式统计

| 分类 | 数量 | 备注 |
|------|------|------|
| 正常转移 | XX件 | {{备注}} |
| 异常转移 | XX件 | {{备注}} |
| 修正转移 | XX件 | {{备注}} |
| 自动转移 | XX件 | {{备注}} |

---

## 主要发现事项

### 重要要点

1. **{{要点1标题}}**
   - {{详细说明}}
   - 影响: {{影响概要}}
   - 风险: 高/中/低

2. **{{要点2标题}}**
   - {{详细说明}}
   - 影响: {{影响概要}}
   - 风险: 高/中/低

3. **{{要点3标题}}**
   - {{详细说明}}
   - 影响: {{影响概要}}
   - 风险: 高/中/低

---

## 复杂的转移模式

### 模式1: {{模式名}}

- **转移流程**: {{状态A}} → {{状态B}} → {{状态C}}
- **触发**: {{触发}}
- **复杂度原因**: {{理由}}
- **相关数据**: {{数据名}}
- **风险**: 高/中/低

---

## 数据依赖关系的整合信息

### 相关数据列表

| 数据名 | 关系类型 | 状态联动 | 风险 |
|---------|---------|---------|-------|
| {{数据A}} | 1:N | 有 | 高/中/低 |
| {{数据B}} | N:1 | 有 | 高/中/低 |
| ... | ... | ... | ... |

### 复合状态依赖

- **模式**: {{模式名}}
- **相关数据**: {{数据名列表}}
- **一致性风险**: 高/中/低

---

## 整合风险评估

| 风险分类 | 评估 | 主要问题点 |
|-----------|------|-----------|
| 状态复杂度 | 高/中/低 | {{问题点}} |
| 数据一致性 | 高/中/低 | {{问题点}} |
| 错误处理 | 高/中/低 | {{问题点}} |
| 可测试性 | 高/中/低 | {{问题点}} |
| 安全性 | 高/中/低 | {{问题点}} |
| 性能 | 高/中/低 | {{问题点}} |

---

## 整合推荐行动

### 优先级: 高(需要立即对应)

1. [{{相对路径}}]({{相对路径}}#L{{行号}}) - {{推荐事项}}
2. [{{相对路径}}]({{相对路径}}#L{{行号}}) - {{推荐事项}}
3. [{{相对路径}}]({{相对路径}}#L{{行号}}) - {{推荐事项}}

### 优先级: 中(需要审查和验证)

1. {{推荐事项}}
2. {{推荐事项}}
3. {{推荐事项}}

### 优先级: 低(建议确认)

1. {{推荐事项}}
2. {{推荐事项}}

---

## 整体改进方针

### 短期改进(1-2周)

1. **{{改进项目1}}**
   - 内容: {{说明}}
   - 预期效果: {{效果}}

2. **{{改进项目2}}**
   (以同样格式描述)

### 中期改进(1-2个月)

1. **{{改进项目}}**
   - 内容: {{说明}}
   - 预期效果: {{效果}}

### 长期改进(3个月以上)

1. **{{改进项目}}**
   - 内容: {{说明}}
   - 预期效果: {{效果}}

---

## 测试策略

### 单元测试强化

- **应该添加的测试用例数**: XX个
- **重点测试对象**:
  1. {{对象1}}
  2. {{对象2}}

### 集成测试强化

- **应该添加的场景数**: XX个
- **重点场景**:
  1. {{场景1}}
  2. {{场景2}}

### E2E测试强化

- **应该添加的用户故事数**: XX个
- **重点故事**:
  1. {{故事1}}
  2. {{故事2}}

---

## 文档整备计划

1. **状态转移规格书的创建**
   - 基于本分析结果的正式规格书
   - 目标读者: 开发者、QA、PO

2. **API规格书的更新**
   - 添加关于状态转移的信息
   - 明文化错误情况

3. **运维文档的创建**
   - 监控方法
   - 故障排除

---

## 额外需要考虑的事项

1. **{{考虑事项1}}**
   - {{详情}}

2. **{{考虑事项2}}**
   - {{详情}}

3. **{{考虑事项3}}**
   - {{详情}}

---

## 详细分析文件列表

以下文件记录了详细的分析结果:

### 初次分析
1. [索引](./index.md)
2. [摘要](./summary.md)
3. [状态转移图](./diagram.md)
4. [转移表](./transitions.md)
5. [功能分析](./functions.md)
6. [数据依赖关系](./dependencies.md)
7. [风险评估](./risks.md)
8. [推荐事项](./recommendations.md)

(如果有额外调查则添加)
### 额外调查
...

---

## 分析的限制事项和注意点

- {{限制事项1}}
- {{限制事项2}}
- {{限制事项3}}

---

*此摘要是整合多个分析结果自动生成的。详情请参考各分析文件。*
```

# 摘要创建注意点

- 全面掌握所有分析文件的内容
- 消除重复信息,简洁总结
- 优先记载最重要的信息
- 识别整体趋势和模式
- **所有文件路径使用相对路径记载(不使用绝对路径)**
- **在500行以内**

必须使用 Write 工具将结果保存到 {{摘要文件名}}。
</summary_template>
