---
description: 整理想法并创建可实现的PRD
allowed-tools: Read, Glob, Grep, Task, Bash, WebSearch, WebFetch, AskUserQuestion
argument-hint: [功能或想法概要(可选)]
---
通过对话整理模糊的想法或需求,创建可实现的PRD(Product Requirements Document)。逐步推进代码库调查、技术验证、需求具体化。

# context

输出目录=".dcs"
当前目录={{项目根目录}}
会话文件列表=[]
迭代次数=0
最大迭代=10

# step

- 如果有 $1,作为初始想法记录
- 如果没有 $1,向用户询问"想咨询什么样的功能或想法?"
- 使用 AskUserQuestion 工具实施初始访谈,并更新 context
- 向用户声明收集的 context 内容
- 执行 step2

## step2: 会话初始化

- 确认现有输出文件,确定不重复的编号
  - 搜索 {{输出目录}}/{{timestamp}}_*
  - 将本次内容简单英语化(例: "order_export", "payment_integration")
  - 如果存在相同 timestamp 和内容的现有目录,将末尾序号 +1
  - 基础目录设为 "{{输出目录}}/{{timestamp}}_{{内容的英语化}}"
    - 例: ".dcs/20251025123456_order_export"
- 准备会话文件列表
  - 索引文件: "{{基础目录}}/index.md"
  - 会话历史文件: "{{基础目录}}/conversation.md"
  - 上下文文件: "{{基础目录}}/context.md"
  - 调查结果文件: "{{基础目录}}/research.md"
  - PRD文件: "{{基础目录}}/prd.md"
- 将所有文件名添加到 会话文件列表
- 创建索引文件,记录会话信息
- 执行 step3

## step3: 对话会话

- 迭代次数 +1
- 向用户确认当前理解状况
  - 简要汇总目前为止的整理内容
  - 列出不明点或需确认的点
- 接收用户的追加信息或问题回答
- 根据需要实施以下内容:
  - **代码库调查**: 使用 Task 工具搜索·分析相关代码
  - **技术调查**: 使用 WebSearch/WebFetch 收集技术信息
  - **确认现有功能**: 使用 Read/Grep 确认现有实现
- 将新信息整合到 context 并整理
- 更新会话历史文件和上下文文件
- 如实施了调查,更新调查结果文件
- 根据 规则 判断下一步行动,并进入相应步骤

## step4: 创建PRD

- 使用 <prd_template> 的内容,通过 Task 工具创建 PRD 文件
  - subagent_type: "general-purpose"
  - description: "创建PRD(Product Requirements Document)"
  - prompt: 用 context 填充的 PRD 模板内容的完整提示词
  - PRD 文件名: "{{基础目录}}/prd.md"
- 最终更新索引文件
- 整理并显示所有会话文件的路径
  - 索引文件
  - 会话历史文件
  - 上下文文件
  - 调查结果文件(如适用)
  - PRD文件
- 向用户报告会话完成
- 向用户提议下一步行动
  - 是否继续实现PRD内容
  - 是否需要进一步细化
  - 是否实施影响范围分析

# rules

## 初始访谈的问题

使用 AskUserQuestion 工具,实施以下问题:

### 问题1: 想法的类别
- **问题**: 此想法属于哪个类别?
- **header**: "类别"
- **multiSelect**: false
- **options**:
  - "新功能的添加" - 想添加全新的功能
  - "现有功能的改善" - 想改善·扩展现有功能
  - "技术性改善" - 性能、架构等技术性改善
  - "错误修正·问题解决" - 想解决已知问题

### 问题2: 优先级和紧急度
- **问题**: 此功能的优先级如何?
- **header**: "优先级"
- **multiSelect**: false
- **options**:
  - "高 - 立即需要" - 业务关键,急需
  - "中 - 近期需要" - 重要但有一定时间余地
  - "低 - 有更好" - Nice to have,有时间的话想实现
  - "调查中 - 尚未决定" - 想咨询以判断优先级

### 问题3: 现状的理解度
- **问题**: 关于此功能相关的技术或代码库,您有多了解?
- **header**: "理解度"
- **multiSelect**: false
- **options**:
  - "详细理解" - 掌握技术栈和代码库
  - "一定程度理解" - 理解概要但细节不明
  - "不太理解" - 技术细节不太清楚
  - "完全不理解" - 希望从头开始教

作为context保持以下内容:
- 想法概要
- 类别
- 优先级
- 理解度
- 相关的现有功能(如已判明)
- 技术性约束(如已判明)

## 判断下一步行动的规则

在各迭代结束时,根据以下标准判断下一步行动:

### 继续 step3 的条件(符合以下任一项)
- 用户的想法仍然模糊,需要具体化
- 需要追加的技术调查或验证
- 与现有代码库的集成方法不明确
- 等待用户的追加信息
- 迭代次数低于最大迭代

### 进入 step4 的条件(符合以下所有项)
- 想法已充分具体化
- 已确认技术可实现性
- 需求已明确定义
- 用户同意创建PRD

### 会话结束条件
- 迭代次数达到最大迭代
- 用户明确希望结束会话

## 文件名规则

### timestamp 的格式
- yyyyMMddHHmmss 格式(例: 20251025123456)

### 内容英语化的规则
- 将想法转换为简洁的英语
- 使用蛇形命名法(snake_case)
- 控制在最多30个字符左右
- 例:
  - "订单历史的导出功能" → "order_export"
  - "支付方式的追加" → "payment_integration"
  - "性能改善" → "performance_improvement"
  - "CSV导入" → "csv_import"

### 会话文件名规则
- `index.md` - 整个会话的索引
- `conversation.md` - 会话历史的记录
- `context.md` - 整理的上下文信息
- `research.md` - 技术调查·代码调查的结果
- `prd.md` - 最终的PRD

### 完整文件名示例
- `.dcs/20251025123456_order_export/index.md`
- `.dcs/20251025123456_order_export/conversation.md`
- `.dcs/20251025123456_order_export/context.md`
- `.dcs/20251025123456_order_export/research.md`
- `.dcs/20251025123456_order_export/prd.md`

## 文件路径记载规则

- **使用以当前目录为基准的相对路径**
- 不记载完整路径(绝对路径)
- 例:
  - ❌ `/Users/makotan/projects/ensemble-si/backend/src/main/kotlin/si/ensemble/api/`
  - ✅ `backend/src/main/kotlin/si/ensemble/api/`

## 对话的指导方针

### 提问的方法
- 从开放式问题开始
- 提供具体选项进行筛选
- 逐步深入技术细节
- 根据用户的理解度进行说明

### 整理的方法
- 注意5W1H(Who, What, When, Where, Why, How)
- 以用户故事形式整理需求
- 分别考虑技术实现方法和需求
- 整理时设定优先级

### 调查的时机
- 需要确认代码库的现有功能时
- 需要验证技术可实现性时
- 寻找类似功能的实现例时
- 需要外部库或API信息时

### Task 利用的指导方针
- 复杂的代码库调查通过 Task 实施
- 当对话变长上下文变复杂时使用 Task
- 调查结果必须保存到文件

## 迭代管理

- 各迭代实施以下内容:
  1. 整理并提示现状理解
  2. 提问不明点或确认事项
  3. 实施必要的调查
  4. 整合新信息
  5. 更新文件
  6. 判断下一步行动

- 在会话历史文件中记录迭代信息
- 达到最大迭代(10次)后,汇总现状并提议创建PRD

# info

## 索引文件的格式

```markdown
# 橡皮鸭会话 - 索引

**开始日期**: {{开始日期}}
**最后更新**: {{最后更新日期}}
**协调者**: Claude Code

---

## 会话概要

### 想法
{{想法概要}}

### 类别
{{类别}}

### 优先级
{{优先级}}

### 当前状态
- **迭代**: {{当前迭代}}/{{最大迭代}}
- **阶段**: 对话中 / PRD创建完成
- **进度**: {{进度状况的简单说明}}

---

## 会话文件一览

- [会话历史](./conversation.md) - 所有对话记录
- [整理的上下文](./context.md) - 需求和技术信息的整理
- [调查结果](./research.md) - 技术调查·代码调查的结果
- [PRD](./prd.md) - 最终的Product Requirements Document

---

## 快速摘要

### 主要需求
1. {{需求1}}
2. {{需求2}}
3. {{需求3}}

### 技术考虑事项
- {{考虑事项1}}
- {{考虑事项2}}

### 下一步
- {{下一步应做的事}}

---

*会话详细请参照各文件。*
```

## 会话历史文件的格式

```markdown
# 橡皮鸭会话 - 会话历史

**开始日期**: {{开始日期}}
**最后更新**: {{最后更新日期}}

[← 返回索引](./index.md)

---

## 迭代 1

**日期**: {{日期}}

### 用户
{{用户的发言}}

### Claude
{{Claude的响应}}

### 行动
- {{实施的行动1}}
- {{实施的行动2}}

---

## 迭代 2

(同样格式记录)

---

*会话按时间顺序记录。*
```

## 上下文文件的格式

```markdown
# 橡皮鸭会话 - 上下文

**最后更新**: {{最后更新日期}}

[← 返回索引](./index.md)

---

## 想法概要

{{想法的详细说明}}

---

## 用户故事

### As a {{用户类型}}
I want to {{想做的事}}
So that {{目的·理由}}

---

## 需求定义

### 功能需求
1. **{{需求1的标题}}**
   - 说明: {{详细说明}}
   - 优先级: 高/中/低
   - 实现方法: {{技术方法}}

2. **{{需求2的标题}}**
   (同样格式)

### 非功能需求
- **性能**: {{性能需求}}
- **安全性**: {{安全性需求}}
- **可用性**: {{可用性需求}}
- **可维护性**: {{可维护性需求}}

---

## 技术考虑事项

### 与现有系统的集成
- {{集成点1}}
- {{集成点2}}

### 技术栈
- **Frontend**: {{使用的技术}}
- **Backend**: {{使用的技术}}
- **Database**: {{使用的技术}}
- **其他**: {{其他技术}}

### 约束条件
- {{约束1}}
- {{约束2}}

---

## 用户界面

### 界面·功能一览
1. {{界面名1}} - {{说明}}
2. {{界面名2}} - {{说明}}

### 数据流
{{说明数据的流动}}

---

## 疑问点·未解决事项

- [ ] {{疑问点1}}
- [ ] {{疑问点2}}
- [x] {{已解决的疑问点}}

---

*此上下文通过对话持续更新。*
```

## 调查结果文件的格式

```markdown
# 橡皮鸭会话 - 调查结果

**最后更新**: {{最后更新日期}}

[← 返回索引](./index.md)

---

## 调查1: {{调查标题}}

**实施日期**: {{日期}}
**目的**: {{调查目的}}

### 调查方法
- {{使用的工具或方法}}

### 调查结果
{{调查得知的事}}

### 相关文件
- [{{文件路径1}}]({{相对路径1}})
- [{{文件路径2}}]({{相对路径2}})

### 结论
{{从调查得到的结论}}

---

## 调查2: {{调查标题}}

(同样格式)

---

## 技术验证摘要

### 可实现性
- **评价**: 高/中/低
- **理由**: {{评价的理由}}

### 风险
1. {{风险1}} - 对策: {{对策}}
2. {{风险2}} - 对策: {{对策}}

### 推荐方法
{{推荐的技术方法}}

---

*调查结果按时间顺序记录。*
```

<prd_template>
您是产品需求定义专家。请根据以下信息,创建可实现的PRD(Product Requirements Document)。

# 创建PRD所需信息

想法概要: {{想法概要}}
类别: {{类别}}
优先级: {{优先级}}
会话文件列表: {{会话文件列表}}
基础目录: {{基础目录}}
当前目录: {{当前目录}}

# 重要注意事项

**所有文件路径请以当前目录为基准记载相对路径。**
**请勿使用绝对路径(/Users/... 或 C:\\... 等)。**
**PRD请以易读且实现者易于理解的格式记述。**

# PRD创建步骤

## 1. 读取会话文件

- 用 Read 读取 {{会话文件列表}} 中包含的所有文件
- 把握会话历史、上下文、调查结果

## 2. 需求整理和优先级设定

- 整理功能需求,设定优先级
- 明确非功能需求
- 定义MVP(Minimum Viable Product)范围

## 3. 明确技术实现方法

- 根据调查结果决定技术方法
- 明记与现有系统的集成方法
- 列出必要的变更位置

## 4. 任务分解

- 将实现任务具体分解
- 设定各任务的估计和优先级
- 明确任务间的依赖关系

## 5. 风险和对策

- 特定技术风险
- 评价业务风险
- 定义各自的对策

## 6. 输出PRD文件

请以下列输出格式保存结果到 {{基础目录}}/prd.md。

# PRD输出格式

```markdown
# PRD: {{功能名}}

**创建日**: {{创建日}}
**最后更新**: {{最后更新日}}
**状态**: Draft / Review / Approved
**优先级**: {{优先级}}

[← 返回索引](./index.md)

---

## 1. 执行摘要

### 概要
{{用3-5行简洁地说明功能概要}}

### 背景和目的
{{为什么需要此功能}}

### 期待的成果
- {{成果1}}
- {{成果2}}
- {{成果3}}

---

## 2. 用户故事

### 主要用户故事
```
As a {{用户类型}}
I want to {{想做的事}}
So that {{目的·理由}}
```

### 次要用户故事
(根据需要追加)

---

## 3. 功能需求

### 3.1 MVP(Minimum Viable Product)范围

#### 必需功能
1. **{{功能1的标题}}**
   - **说明**: {{详细说明}}
   - **验收标准**:
     - [ ] {{标准1}}
     - [ ] {{标准2}}
   - **优先级**: 高
   - **估计**: {{工时}}

2. **{{功能2的标题}}**
   (同样格式)

#### 排除的功能(计划将来实现)
- {{排除功能1}} - 理由: {{理由}}
- {{排除功能2}} - 理由: {{理由}}

### 3.2 阶段2以后的功能
(MVP后计划实现的功能)

---

## 4. 非功能需求

### 4.1 性能
- **响应时间**: {{需求}}
- **吞吐量**: {{需求}}
- **资源使用量**: {{需求}}

### 4.2 安全性
- **认证·授权**: {{需求}}
- **数据保护**: {{需求}}
- **审计日志**: {{需求}}

### 4.3 可用性·可靠性
- **运行率**: {{目标值}}
- **错误处理**: {{需求}}
- **数据备份**: {{需求}}

### 4.4 可维护性·可扩展性
- **代码质量**: {{标准}}
- **测试覆盖率**: {{目标值}}
- **文档**: {{需求}}

---

## 5. 技术规格

### 5.1 架构

#### 系统构成
{{系统构成图或说明}}

#### 组件
- **Frontend**: {{使用技术和方法}}
- **Backend**: {{使用技术和方法}}
- **Database**: {{使用技术和方法}}

### 5.2 数据模型

#### 新建表·资源
1. **{{表名1}}**
   - 目的: {{目的}}
   - 主要字段:
     - `{{字段1}}`: {{类型}} - {{说明}}
     - `{{字段2}}`: {{类型}} - {{说明}}

#### 现有表·资源的变更
1. **{{表名}}**
   - 变更内容: {{变更说明}}
   - 影响: {{影响范围}}

### 5.3 API设计

#### 新建端点
1. **POST /api/{{端点}}**
   - 目的: {{目的}}
   - 请求: {{请求格式}}
   - 响应: {{响应格式}}

#### 现有端点的变更
1. **GET /api/{{端点}}**
   - 变更内容: {{变更说明}}
   - 向后兼容性: {{兼容性的保证方法}}

### 5.4 UI/UX设计

#### 界面一览
1. **{{界面名1}}**
   - 目的: {{目的}}
   - 主要元素: {{元素列表}}
   - 线框图: {{链接或说明}}

#### 用户流程
{{说明用户的操作流程}}

---

## 6. 实现计划

### 6.1 任务分解

#### 阶段1: 基础实现(估计: {{工时}})
1. **{{任务1}}**
   - 内容: {{详细}}
   - 负责: {{负责人或团队}}
   - 估计: {{工时}}
   - 依赖: 无

2. **{{任务2}}**
   - 内容: {{详细}}
   - 负责: {{负责人或团队}}
   - 估计: {{工时}}
   - 依赖: {{任务1}}

#### 阶段2: 功能实现(估计: {{工时}})
(同样格式)

#### 阶段3: 测试·集成(估计: {{工时}})
(同样格式)

### 6.2 里程碑

| 里程碑 | 完成条件 | 期限 |
|--------------|---------|------|
| {{里程碑1}} | {{完成条件}} | {{期限}} |
| {{里程碑2}} | {{完成条件}} | {{期限}} |

---

## 7. 测试策略

### 7.1 单元测试
- **对象**: {{测试对象}}
- **覆盖率目标**: {{目标值}}
- **重点项目**: {{重点测试项目}}

### 7.2 集成测试
- **对象**: {{测试对象}}
- **场景**: {{主要测试场景}}

### 7.3 E2E测试
- **对象**: {{测试对象}}
- **用户场景**: {{主要用户场景}}

### 7.4 性能测试
- **对象**: {{测试对象}}
- **负载条件**: {{负载条件}}
- **合格标准**: {{合格标准}}

---

## 8. 风险和对策

### 8.1 技术风险

| 风险 | 影响度 | 发生概率 | 对策 |
|--------|--------|---------|------|
| {{风险1}} | 高/中/低 | 高/中/低 | {{对策}} |
| {{风险2}} | 高/中/低 | 高/中/低 | {{对策}} |

### 8.2 业务风险

| 风险 | 影响度 | 发生概率 | 对策 |
|--------|--------|---------|------|
| {{风险1}} | 高/中/低 | 高/中/低 | {{对策}} |

---

## 9. 依赖关系和前提条件

### 9.1 技术依赖
- {{依赖1}} - {{状态}}
- {{依赖2}} - {{状态}}

### 9.2 业务依赖
- {{依赖1}} - {{状态}}
- {{依赖2}} - {{状态}}

### 9.3 前提条件
- {{前提1}}
- {{前提2}}

---

## 10. 成功指标(KPI)

### 定量指标
- **{{指标1}}**: 目标值 {{值}},测量方法 {{方法}}
- **{{指标2}}**: 目标值 {{值}},测量方法 {{方法}}

### 定性指标
- {{指标1}}
- {{指标2}}

---

## 11. 发布计划

### 11.1 发布策略
- **发布方法**: {{方法}}(例: 金丝雀发布、逐步推出)
- **回滚计划**: {{回滚方法}}

### 11.2 迁移计划
(需要从现有功能迁移的情况)
- {{迁移步骤1}}
- {{迁移步骤2}}

### 11.3 培训·文档
- **用户文档**: {{必要的文档}}
- **开发者文档**: {{必要的文档}}
- **培训**: {{必要的培训}}

---

## 12. 相关文档

- [会话历史](./conversation.md) - 会话的全对话记录
- [上下文](./context.md) - 整理的需求信息
- [调查结果](./research.md) - 技术调查的详细

---

## 13. 批准

| 角色 | 姓名 | 批准日 | 状态 |
|------|------|--------|-----------|
| 产品负责人 | {{姓名}} | {{日期}} | Pending/Approved |
| 技术负责人 | {{姓名}} | {{日期}} | Pending/Approved |
| 架构师 | {{姓名}} | {{日期}} | Pending/Approved |

---

## 变更历史

| 日期 | 版本 | 变更内容 | 变更者 |
|------|----------|---------|--------|
| {{日期}} | 1.0 | 创建初版 | Claude Code |

---

*此PRD通过对话会话创建。实现前请获得相关人员的审查和批准。*
```

# PRD创建的注意点

- 使内容具体易于实现者理解
- 明确记述技术实现方法
- 将任务分解到可实现的粒度
- 现实地评价风险和对策
- **所有文件路径以相对路径记载(不使用绝对路径)**
- 基于现有代码库和技术栈的现实内容

请务必使用 Write 工具,将结果保存到 {{基础目录}}/prd.md。
</prd_template>

# 注意事项

- 根据用户的理解度进行说明
- 逐步深入技术细节
- 定期确认理解状况,根据需要进行调整
- 始终考虑可实现性,提出现实的建议
- 对话变长时适当利用 Task 整理上下文
- 所有文件路径以相对路径记载
- 会话内容持续保存到文件
