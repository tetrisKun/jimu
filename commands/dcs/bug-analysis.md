---
description: 实施详细分析以确定错误原因
allowed-tools: Read, Glob, Grep, Task, Bash, AskUserQuestion
argument-hint: [错误概要(可选)]
---
从错误的发生经过和症状出发确定原因,并提出修正方针。详细分析源代码,逐步缩小原因范围。

# context

输出目录=".dcs"
当前目录={{项目根目录}}
分析文件列表=[]
调查阶段=1

# step

- 如果有 $1,简要说明其内容
- 执行 step1

## step1: 初始信息收集

- 使用 AskUserQuestion 工具依次实施以下问题,并更新 context:
  1. 确认错误类型
  2. 确认错误发生情况
  3. 确认错误信息的有无
  4. 确认重现步骤的有无
- 汇总收集的 context 内容并向用户声明
- 执行 step2

## step2: 执行初始调查

- 确认现有输出文件,确定不重复的编号
  - 搜索 {{输出目录}}/{{timestamp}}_*/
  - 将错误内容简单英语化(例: "order_total_bug", "cart_display_issue")
  - 如果存在相同 timestamp 和内容的现有目录,将末尾序号 +1
  - 基础目录设为 "{{输出目录}}/{{timestamp}}_{{内容的英语化}}"
    - 例: ".dcs/20251025_143022_order_total_bug"
- 准备分析结果文件列表
  - 索引文件: "{{基础目录}}/index.md"
  - 初始调查文件: "{{基础目录}}/initial_investigation.md"
  - 处理流程分析文件: "{{基础目录}}/flow_analysis.md"
  - 详细原因分析文件: "{{基础目录}}/root_cause_analysis.md"
  - 最终报告文件: "{{基础目录}}/final_report.md"
- 将所有文件名添加到 分析文件列表
- 用 context 信息填充 <initial_investigation_template> 的内容,并使用 Task 工具直接执行
  - subagent_type: "general-purpose"
  - description: "执行错误初始调查"
  - prompt: 用 context 填充的模板完整提示词
- 接收 Task 的执行结果
- 执行 step3

## step3: 执行处理流程分析

- 使用 Read 确认初始调查结果
- 向用户确认是否有需要额外确认的信息
- 获得用户批准后继续
- 用 context 和初始调查结果填充 <flow_analysis_template> 的内容,并使用 Task 工具执行
  - subagent_type: "general-purpose"
  - description: "执行错误处理流程分析"
  - prompt: 填充的模板完整提示词
- 接收 Task 的执行结果
- 执行 step4

## step4: 执行详细原因分析

- 使用 Read 确认处理流程分析结果
- 用 context 和目前为止的分析结果填充 <root_cause_analysis_template> 的内容,并使用 Task 工具执行
  - subagent_type: "general-purpose"
  - description: "执行错误详细原因分析"
  - prompt: 填充的模板完整提示词
- 接收 Task 的执行结果
- 执行 step5

## step5: 创建最终报告

- 使用 <final_report_template> 的内容,通过 Task 工具创建最终报告
  - subagent_type: "general-purpose"
  - description: "创建错误分析最终报告"
  - prompt: 用 context 填充的模板完整提示词
  - 最终报告文件名: "{{基础目录}}/final_report.md"
- 按阶段整理并显示所有分析文件的路径
  - 初始调查文件
  - 处理流程分析文件
  - 详细原因分析文件
  - 最终报告
- 向用户报告分析完成

# rules

## 确认要点

使用 AskUserQuestion 工具,依次实施以下问题:

### 问题1: 错误类型
- **问题**: 此错误属于哪个类别?
- **header**: "错误类型"
- **multiSelect**: true
- **options**:
  - "UI/显示错误" - 界面显示、布局、样式问题
  - "逻辑错误" - 业务逻辑、计算处理、条件分支问题
  - "数据错误" - 数据库、API、状态管理问题
  - "集成错误" - 组件间协作、外部系统协作问题
  - "性能错误" - 处理速度、内存使用量问题

### 问题2: 错误发生情况
- **问题**: 错误在什么情况下发生?
- **header**: "发生情况"
- **options**:
  - "总是发生" - 特定操作必定发生
  - "特定条件发生" - 仅在特定数据或状态下发生
  - "间歇性发生" - 重现性低,偶尔发生
  - "环境依赖" - 仅在特定环境下发生

### 问题3: 错误信息的有无
- **问题**: 是否有错误日志或错误消息?
- **header**: "错误信息"
- **options**:
  - "有(详细)" - 有堆栈跟踪或错误消息
  - "有(简易)" - 仅有错误消息
  - "无" - 没有错误信息但行为异常

### 问题4: 重现步骤的有无
- **问题**: 重现错误的步骤是否明确?
- **header**: "重现步骤"
- **options**:
  - "明确" - 有确实可重现的步骤
  - "大致" - 大致知道步骤但不确实
  - "不明" - 不知道重现步骤

作为context保持以下内容:
- 错误概要
- 错误类型
- 发生情况
- 错误信息的有无
- 重现步骤的有无
- 其他错误详细信息

## 文件名规则

### timestamp 的格式
- yyyyMMddHHmmss 格式(例: 20251025143022)

### 内容英语化的规则
- 将错误内容转换为简洁的英语
- 使用蛇形命名法(snake_case)
- 控制在最多30个字符左右
- 例:
  - "订单合计的计算错误" → "order_total_bug"
  - "购物车显示问题" → "cart_display_issue"
  - "支付错误" → "payment_error"
  - "性能问题" → "performance_issue"

### 按节文件名规则
- 分析结果按阶段分割,每个文件目标在500行以内
- 文件一览:
  - `_index.md` - 索引(整体概要和文件一览)
  - `_initial_investigation.md` - 初始调查结果
  - `_flow_analysis.md` - 处理流程分析
  - `_root_cause_analysis.md` - 详细原因分析
  - `_final_report.md` - 最终报告

### 完整文件名示例
- `.dcs/20251025143022_order_total_bug/index.md`
- `.dcs/20251025143022_order_total_bug/initial_investigation.md`
- `.dcs/20251025143022_order_total_bug/flow_analysis.md`
- `.dcs/20251025143022_order_total_bug/root_cause_analysis.md`
- `.dcs/20251025143022_order_total_bug/final_report.md`

## 文件路径记载规则

- **使用以当前目录为基准的相对路径**
- 不记载完整路径(绝对路径)
- 例:
  - ❌ `/Users/makotan/projects/ensemble-si/src/utils/helper.ts`
  - ✅ `src/utils/helper.ts`
- 当前目录为分析开始时的工作目录
- 所有文件路径统一使用相对路径

## 按错误类型的分析方法

### UI/显示错误
- 组件的结构和属性
- 样式定义和CSS应用情况
- 数据绑定的确认
- 条件渲染的验证
- 浏览器兼容性的确认

### 逻辑错误
- 函数·方法的输入输出
- 条件分支的逻辑
- 计算处理的精度
- 边缘情况的处理
- 错误处理

### 数据错误
- 数据流的追踪
- API调用和响应
- 状态管理的一致性
- 数据库查询
- 数据转换处理

### 集成错误
- 组件间的数据传递
- 事件传播
- API协作的序列
- 异步处理的时机
- 事务边界

### 性能错误
- N+1问题的检测
- 重复处理的特定
- 不必要的重新渲染
- 内存泄漏的可能性
- 低效算法

## 原因特定的观点

### 代码解析的观点
1. **控制流**: 条件分支、循环、异常处理
2. **数据流**: 变量的生成、转换、利用
3. **依赖关系**: 模块间、函数间的依赖
4. **副作用**: 状态变更、对外部系统的影响
5. **时机**: 异步处理、事件顺序

### 应验证的要点
- 输入值的验证
- 边界值的处理
- null检查
- 类型的一致性
- 错误处理的全面性

### 常见原因模式
- 未初始化变量的使用
- null指针引用
- 数组的越界访问
- 类型不匹配
- 异步处理的冲突
- 内存泄漏
- 无限循环
- 不适当的错误处理

# info

<initial_investigation_template>
您是错误原因特定专家。根据以下信息,实施错误的初始调查,特定相关代码位置。

# 错误的基本信息

错误概要: {{错误概要}}
错误类型: {{错误类型}}
发生情况: {{发生情况}}
错误信息: {{错误信息的有无和内容}}
重现步骤: {{重现步骤的有无和内容}}
其他信息: {{其他错误详细信息}}

输出文件名: {{基础目录}}/initial_investigation.md
当前目录: {{当前目录}}

# 重要注意事项

**所有文件路径请以当前目录为基准记载相对路径。**
**请勿使用绝对路径(/Users/... 或 C:\\... 等)。**
**此文件目标在500行以内。**

# 初始调查的步骤

## 1. 根据错误类型决定搜索策略

根据错误类型({{错误类型}})决定适当的搜索方法:

### UI/显示错误的情况
- 特定组件文件(.tsx, .jsx, .vue 等)
- 确认样式定义(CSS, styled-components 等)
- 确认数据绑定

### 逻辑错误的情况
- 特定相关函数·方法
- 确认业务逻辑的位置
- 搜索计算处理的代码

### 数据错误的情况
- 确认API定义
- 特定数据模型
- 确认状态管理代码

### 集成错误的情况
- 确认组件间协作
- API调用的序列
- 追踪事件处理器

### 性能错误的情况
- 检测重复处理
- 确认N+1问题
- 特定不必要的重新渲染

## 2. 从错误信息中提取线索

如果有{{错误信息的有无和内容}}:
- 从错误消息特定相关代码位置
- 从堆栈跟踪追踪调用路径
- 从错误代码搜索相应处理

## 3. 特定相关功能·组件

### 使用的工具
- Grep: 通过关键词搜索特定代码位置
- Glob: 通过文件模式列举相关文件
- Read: 确认特定文件的内容

### 搜索关键词的选定
- 从错误概要中提取重要关键词
- 相关函数名、类名、组件名
- 错误消息的一部分

### 搜索的实施
1. 用最有可能的关键词进行 Grep 搜索
2. 用 Read 确认找到的文件
3. 根据需要用追加关键词搜索
4. 用 Glob 列举相关文件

## 4. 理解代码库的结构

### 确认项目结构
- frontend/ - 前端应用程序
- admin/ - 管理界面
- backend/ - 后端API
- prismatix-factory/ - 资源定义

### 理解架构模式
- BFF(Backend for Frontend)模式
- 通过 Next.js API 路由调用后端
- 通过 Prismatix Factory 生成代码

## 5. 汇总初始调查结果

请以下列格式将结果输出到文件。使用 Write 工具保存。

```markdown
# 错误初始调查结果

**实施日期**: {{实施日期}}
**分析者**: Claude Code

[← 返回索引](./index.md)

---

## 错误的基本信息

### 概要
{{错误概要}}

### 错误类型
{{错误类型}}

### 发生情况
{{发生情况}}

### 错误信息
{{错误信息的详细}}

### 重现步骤
{{重现步骤的详细}}

---

## 相关组件·文件

### 主要相关文件

#### [相对路径](相对路径)
- **作用**: {{此文件的作用}}
- **相关度**: 高/中/低
- **理由**: {{为什么此文件相关}}
- **重要代码位置**:
  - 行号: {{行号}}
  - 内容: {{代码概要}}

#### [相对路径](相对路径)
(同样格式记载多个)

### 辅助相关文件

#### [相对路径](相对路径)
- **作用**: {{此文件的作用}}
- **相关度**: 中/低
- **理由**: {{为什么此文件相关}}

---

## 搜索关键词和结果

### 使用的关键词
1. `{{关键词1}}` - XX件命中
2. `{{关键词2}}` - XX件命中
3. `{{关键词3}}` - XX件命中

### 搜索结果摘要
{{搜索结果的总结}}

---

## 代码库结构的理解

### 架构上的定位
{{此错误相关组件在架构上的位置}}

### 数据流的概要
{{数据如何流动}}

```
{{数据流图(文本格式)}}
例:
Frontend Component
  ↓ (API调用)
Next.js API Route (BFF)
  ↓ (HTTP Request)
Backend API
  ↓ (DLL调用)
Prismatix Factory
  ↓ (SQL)
PostgreSQL
```

---

## 初始假设

### 可能性高的原因候选

#### 候选1: {{原因概要}}
- **确度**: 高/中/低
- **理由**: {{为什么此可能性高}}
- **相应位置**: [相对路径:行号](相对路径#L行号)
- **验证方法**: {{应如何验证}}

#### 候选2: {{原因概要}}
(同样格式记载多个)

### 可能性低的候选
{{可能性虽低但谨慎记载的候选}}

---

## 下一阶段的调查方针

### 处理流程分析中应确认的点
1. {{确认要点1}}
2. {{确认要点2}}
3. {{确认要点3}}

### 需要额外确认的信息
{{如有需向用户确认的信息请记载}}

---

## 限制事项

### 可能未检测到的位置
- {{限制事项1}}
- {{限制事项2}}

---

*此初始调查结果为自动生成。下一阶段的处理流程分析将进一步确认详细。*
```

# 调查的注意点

- 动态调用(反射、eval 等)难以检测
- 通过字符串的间接引用难以检测
- 排除注释掉的代码
- 如有相关性也包含测试代码
- **所有文件路径以相对路径记载(不使用绝对路径)**
- **文件目标在500行以内**

最后,也请创建索引文件({{基础目录}}/index.md)。索引文件请包含以下内容:

```markdown
# 错误原因分析 - 索引

**实施日期**: {{实施日期}}
**分析者**: Claude Code

---

## 错误信息

### 概要
{{错误概要}}

### 类型
{{错误类型}}

---

## 分析结果文件一览

### 调查阶段
- [初始调查](./initial_investigation.md) - 特定相关组件
- [处理流程分析](./flow_analysis.md) - ※尚未执行
- [详细原因分析](./root_cause_analysis.md) - ※尚未执行
- [最终报告](./final_report.md) - ※尚未执行

---

## 快速摘要

### 初始假设
1. {{假设1}}
2. {{假设2}}
3. {{假设3}}

### 下一步行动
{{下一步应实施的事}}

---

*分析将分阶段实施。各阶段详细请从上述链接参照。*
```
</initial_investigation_template>

<flow_analysis_template>
您是错误原因特定专家。根据初始调查结果,详细分析错误发生前的处理流程。

# 分析对象的信息

错误概要: {{错误概要}}
错误类型: {{错误类型}}
初始调查结果文件: {{基础目录}}/initial_investigation.md
输出文件名: {{基础目录}}/flow_analysis.md
当前目录: {{当前目录}}

# 重要注意事项

**所有文件路径请以当前目录为基准记载相对路径。**
**请勿使用绝对路径(/Users/... 或 C:\\... 等)。**
**此文件目标在500行以内。如超过500行请分割为多个文件。**

# 处理流程分析的步骤

## 1. 确认初始调查结果

- 用 Read 读取 {{基础目录}}/initial_investigation.md
- 把握特定的相关文件和初始假设
- 明确分析的焦点

## 2. 特定入口点

### UI/显示错误的情况
- 用户操作的界面组件
- 事件处理器
- useEffect 等生命周期钩子

### 逻辑错误的情况
- API端点
- 服务层的函数
- 业务逻辑的开始点

### 数据错误的情况
- 数据获取的API调用
- 状态管理的初始化
- 数据库查询的发出位置

### 集成错误的情况
- 组件间的接口
- API调用的开始点
- 事件触发的起点

### 性能错误的情况
- 发生性能瓶颈的处理
- 循环处理
- 反复调用的函数

## 3. 处理流程的追踪

### 逐步分析
对各处理步骤记录以下内容:
1. **步骤编号**: 处理的顺序
2. **文件和行号**: [相对路径:行号](相对路径#L行号)
3. **处理内容**: 在做什么
4. **输入**: 接收什么样的数据
5. **输出**: 返回什么样的数据
6. **副作用**: 状态变更、API调用等
7. **注目点**: 可能与错误相关的要点

### 数据的转换追踪
- 数据如何转换
- 类型的变更
- 值的计算
- 过滤、映射等操作

### 状态的变化追踪
- 在什么时间点哪个状态改变
- 状态变更的触发器
- 状态的依赖关系

### 条件分支的分析
- 条件式的评价
- 各分支的处理内容
- 在错误发生条件下的分支

## 4. 异常系统的处理确认

### 错误处理
- try-catch 块的配置
- 错误的传播路径
- 错误消息的生成

### 验证
- 输入值的检验
- 边界值的检查
- null/undefined 检查

### 守卫条件
- early return
- 默认值的设置
- 回退处理

## 5. 异步处理的分析

### Promise/async-await
- 异步处理的顺序
- await的有无
- Promise.all等并行处理

### 时机的问题
- 竞争条件
- 状态的更新时机
- 事件的触发顺序

## 6. 汇总处理流程分析结果

请以下列格式将结果输出到文件。使用 Write 工具保存。

```markdown
# 错误处理流程分析

**实施日期**: {{实施日期}}
**分析者**: Claude Code

[← 返回索引](./index.md) | [初始调查](./initial_investigation.md)

---

## 分析对象

### 错误概要
{{错误概要}}

### 分析焦点
{{初始调查中特定的主要相关位置}}

---

## 入口点

### [相对路径:行号](相对路径#L行号)

**作用**: {{入口点的作用}}

**代码片段**:
```{{language}}
{{相关代码的摘录(10行左右)}}
```

**触发器**: {{此入口点被调用的条件}}

---

## 处理流程的详细

### 步骤1: {{步骤名称}}

**文件**: [相对路径:行号](相对路径#L行号)

**处理内容**:
{{此处理中进行什么}}

**输入**:
- `{{变量名}}`: {{类型}} - {{说明}}
- `{{变量名}}`: {{类型}} - {{说明}}

**输出**:
- `{{变量名}}`: {{类型}} - {{说明}}

**副作用**:
- {{状态变更、API调用等}}

**代码片段**:
```{{language}}
{{相关代码的摘录}}
```

**注目点**:
{{可能与错误相关的要点}}

---

### 步骤2: {{步骤名称}}

(同样格式记载各步骤)

---

### 步骤N: {{步骤名称}}

(处理流程的最终步骤)

---

## 数据流的详细

### 数据转换的追踪

```
{{数据的转换流程(文本格式)}}
例:
初始数据: { orderId: "123", items: [...] }
  ↓ (步骤1: 数据获取)
API响应: { order: {...}, total: 1000 }
  ↓ (步骤2: 数据整理)
整理后数据: { id: "123", amount: 1000, ... }
  ↓ (步骤3: 状态更新)
最终状态: OrderState = { ... }
```

### 重要的数据转换要点

#### 转换1: {{转换名称}}
- **位置**: [相对路径:行号](相对路径#L行号)
- **转换前**: {{转换前的数据结构}}
- **转换后**: {{转换后的数据结构}}
- **转换逻辑**: {{如何转换}}
- **注目点**: {{与错误相关的可能性}}

---

## 状态变化的追踪

### 状态的变更履历

| 步骤 | 状态变量 | 变更前的值 | 变更后的值 | 变更位置 |
|---------|---------|-----------|-----------|---------|
| 步骤1 | `{{变量名}}` | `{{值}}` | `{{值}}` | [相对路径:行号](相对路径#L行号) |
| 步骤2 | `{{变量名}}` | `{{值}}` | `{{值}}` | [相对路径:行号](相对路径#L行号) |

### 重要的状态变更

#### 状态变更1: {{变更概要}}
- **时机**: {{何时变更}}
- **触发器**: {{什么引起变更}}
- **影响范围**: {{对哪个组件有影响}}
- **注目点**: {{与错误相关的可能性}}

---

## 条件分支的分析

### 重要的条件分支

#### 分支1: {{分支概要}}

**位置**: [相对路径:行号](相对路径#L行号)

**条件式**:
```{{language}}
{{条件式的代码}}
```

**分支模式**:
- **条件A(为真的情况)**: {{处理内容}} → 到步骤{{N}}
- **条件B(为假的情况)**: {{处理内容}} → 到步骤{{M}}

**错误发生时的条件**:
{{错误发生情况下条件式的评价结果}}

**注目点**:
{{与错误相关的可能性}}

---

## 异常系统的处理

### 错误处理的实现状况

#### 错误处理1: {{错误种类}}

**位置**: [相对路径:行号](相对路径#L行号)

**对象错误**: {{捕捉什么样的错误}}

**处理内容**:
```{{language}}
{{错误处理的代码}}
```

**问题点**:
{{不充分的点、应改善的点}}

### 验证的实现状况

#### 验证1: {{验证内容}}

**位置**: [相对路径:行号](相对路径#L行号)

**验证项目**: {{在验证什么}}

**实现的有无**: ✅ 已实现 / ❌ 未实现

**问题点**:
{{不充分的点、应改善的点}}

---

## 异步处理的分析

### 异步处理的顺序

```
{{异步处理的序列(文本格式)}}
例:
1. 用户操作
   ↓
2. API调用开始(异步)
   ↓ (await)
3. API响应接收
   ↓
4. 状态更新(同步)
   ↓
5. 重新渲染
```

### 时机问题的可能性

#### 时机问题1: {{问题概要}}

**位置**: [相对路径:行号](相对路径#L行号)

**问题详细**:
{{竞争条件、顺序问题等}}

**发生条件**:
{{在什么条件下发生问题}}

**影响**:
{{对错误的影响}}

---

## 流程分析的所见

### 发现的问题点

#### 问题点1: {{问题概要}}
- **严重度**: 高/中/低
- **位置**: [相对路径:行号](相对路径#L行号)
- **详细**: {{问题的详细说明}}
- **与错误的关联**: {{如何关联此错误}}

#### 问题点2: {{问题概要}}
(同样格式记载多个)

### 下一阶段应详细调查的位置

1. **{{调查要点1}}**
   - 理由: {{为什么需要详细调查}}
   - 着眼点: {{应着眼什么}}

2. **{{调查要点2}}**
   (同样格式记载)

---

*基于此处理流程分析结果,下一阶段将实施详细原因分析。*
```

# 分析的注意点

- 处理流程按时间顺序记载
- 各步骤的代码片段简洁(10行左右)
- 明确追踪数据和状态的变化
- 强调可能与错误相关的要点
- **所有文件路径以相对路径记载(不使用绝对路径)**
- **文件目标在500行以内。超过时请分割**

分析完成后,请更新索引文件({{基础目录}}/index.md),启用到处理流程分析的链接。
</flow_analysis_template>

<root_cause_analysis_template>
您是错误原因特定专家。根据目前为止的分析结果,特定错误的根本原因,并实施详细验证。

# 分析对象的信息

错误概要: {{错误概要}}
错误类型: {{错误类型}}
初始调查结果文件: {{基础目录}}/initial_investigation.md
处理流程分析文件: {{基础目录}}/flow_analysis.md
输出文件名: {{基础目录}}/root_cause_analysis.md
当前目录: {{当前目录}}

# 重要注意事项

**所有文件路径请以当前目录为基准记载相对路径。**
**请勿使用绝对路径(/Users/... 或 C:\\... 等)。**
**此文件目标在500行以内。如超过500行请分割为多个文件。**

# 详细原因分析的步骤

## 1. 整合目前为止的分析结果

- 用 Read 读取 {{基础目录}}/initial_investigation.md
- 用 Read 读取 {{基础目录}}/flow_analysis.md
- 整合初始假设和处理流程分析得到的所见
- 特定最有可能的原因候选

## 2. 缩小原因候选

### 与常见原因模式的对照

#### 未初始化变量
- 变量在使用前是否已初始化
- 默认值是否适当
- 条件性初始化的遗漏

#### null指针/undefined引用
- null/undefined检查是否适当
- 可选链的使用
- 默认值的设置

#### 数组的越界访问
- 索引的范围检查
- 空数组的处理
- 边界值的行为

#### 类型不匹配
- 类型转换的适当性
- TypeScript/类型定义的一致性
- 隐式类型转换导致的问题

#### 异步处理的问题
- await的遗漏
- Promise.all的适当使用
- 竞争条件
- 状态更新的时机

#### 逻辑错误
- 条件式的错误
- 计算式的错误
- 循环的终止条件
- 边缘情况的处理遗漏

#### 内存相关
- 内存泄漏的可能性
- 循环引用
- 事件监听器的解除遗漏

#### 错误处理的不备
- try-catch的范围
- 错误的传播
- 错误消息的不适当

### 按错误类型的检查要点

#### UI/显示错误
- 数据绑定的错误
- 条件渲染的逻辑
- 样式的优先级
- useEffect的依赖数组
- 重新渲染的时机

#### 逻辑错误
- 业务规则的实现错误
- 计算逻辑的错误
- 条件分支的不备
- 边缘情况的考虑遗漏

#### 数据错误
- 数据转换的错误
- API契约的不一致
- 状态的一致性
- 缓存的问题

#### 集成错误
- 接口的不一致
- 数据的传递错误
- 事件的传播问题
- 事务边界

#### 性能错误
- N+1问题
- 不必要的重新计算
- 大量数据的低效处理
- 记忆化的不足

## 3. 详细代码验证

### 相应位置的彻底调查
- 代码的详细阅读
- 变量的作用域确认
- 函数的输入输出验证
- 副作用的特定

### 边界值的行为确认
- 最小值的行为
- 最大值的行为
- 空数据的行为
- null/undefined的行为

### 边缘情况的验证
- 意料之外的输入
- 极端的数据大小
- 并行执行
- 错误发生时的行为

## 4. 相关代码的确认

### 调用方的确认
- 用什么样的参数调用
- 调用时机
- 多次调用的可能性

### 被调用方的确认
- 依赖函数的行为
- 外部API的规格
- 库的使用方法

### 测试代码的确认
- 现有的测试用例
- 测试未覆盖的范围
- 测试是否失败

## 5. 特定根本原因

### 根本原因的定义
- 技术原因
- 业务逻辑的问题
- 设计上的问题
- 实现的错误

### 原因的验证
- 从代码看明显的问题
- 与文档的对照
- 与规格的一致性

## 6. 汇总详细原因分析结果

请以下列格式将结果输出到文件。使用 Write 工具保存。

```markdown
# 错误详细原因分析

**实施日期**: {{实施日期}}
**分析者**: Claude Code

[← 返回索引](./index.md) | [初始调查](./initial_investigation.md) | [处理流程](./flow_analysis.md)

---

## 分析摘要

### 错误概要
{{错误概要}}

### 目前为止的分析经过
{{初始调查和处理流程分析中判明的事}}

---

## 原因候选的评价

### 候选1: {{原因概要}}

**确度**: ⭐⭐⭐⭐⭐ (5阶段评价)

**位置**: [相对路径:行号](相对路径#L行号)

**问题详细**:
{{技术问题的详细说明}}

**相应代码**:
```{{language}}
{{有问题的代码片段(20行左右)}}
```

**问题点的指出**:
```{{language}}
// ❌ 有问题的代码
{{提取有问题的部分}}

// ✅ 期待的行为
{{本应如何}}
```

**为什么这是问题**:
{{详细说明此问题引起错误的理由}}

**与错误的关联性**:
{{如何与报告的错误症状联系}}

**验证内容**:
1. {{验证的内容1}}
2. {{验证的内容2}}
3. {{验证的内容3}}

**验证结果**:
{{从验证得到的确证}}

---

### 候选2: {{原因概要}}

(与候选1同样格式记载)

---

### 候选3: {{原因概要}}

(即使确度低也包含记载)

---

## 根本原因的特定

### 最有可能的根本原因

**结论**: {{根本原因的结论}}

**原因的分类**:
- [ ] 未初始化变量
- [ ] null/undefined引用
- [ ] 数组的越界访问
- [ ] 类型不匹配
- [ ] 异步处理的问题
- [ ] 逻辑的错误
- [ ] 内存相关
- [ ] 错误处理的不备
- [x] {{相应的分类}}

**技术说明**:
{{从技术观点的原因说明}}

**发生机制**:
```
{{逐步说明错误发生前的步骤}}
例:
1. 用户执行特定操作
   ↓
2. 调用{{文件名}}的{{函数名}}
   ↓
3. 变量{{变量名}}在未初始化状态下被引用
   ↓
4. 对undefined执行{{操作}}
   ↓
5. 发生错误或错误显现化
```

**为什么至今未发现**:
{{此错误至今被遗漏的理由}}

---

## 详细代码验证

### 问题位置的详细分析

#### [相对路径:行号](相对路径#L行号)

**代码整体**:
```{{language}}
{{有问题的函数·方法整体(根据需要40行左右)}}
```

**有问题的部分**:
```{{language}}
{{提取特别有问题的5-10行}}
```

**详细说明**:
{{逐行的详细分析}}

**变量的状态**:
| 变量名 | 此时的值 | 期待的值 | 问题 |
|-------|-------------|-------------|------|
| `{{变量名}}` | `{{实际值}}` | `{{期待值}}` | {{问题点}} |

**执行流程**:
```
{{此位置的执行流程详细}}
```

**边缘情况下的行为**:
- **正常系统**: {{正常时的行为}}
- **异常系统**: {{异常时的行为}} ← 错误发生
- **边界值**: {{边界值的行为}}

---

## 影响范围的确认

### 此错误影响的范围

#### 直接影响
1. **{{影响1}}**
   - 影响位置: [相对路径:行号](相对路径#L行号)
   - 影响内容: {{有什么样的影响}}

2. **{{影响2}}**
   (同样格式记载)

#### 间接影响
1. **{{影响1}}**
   - 影响路径: {{通过什么路径影响}}
   - 影响内容: {{有什么样的影响}}

---

## 相关的问题点

### 类似错误的可能性

#### 类似位置1: [相对路径:行号](相对路径#L行号)
- **类似度**: 高/中/低
- **问题内容**: {{有同样模式问题的可能性}}
- **确认的必要性**: {{是否应确认}}

### 设计上的问题

{{如果根本原因起因于设计}}
- **问题点**: {{设计上的问题}}
- **影响范围**: {{影响多大范围}}
- **根本对策**: {{需要什么样的对策}}

---

## 测试用例的验证

### 现有测试的确认

#### 测试文件: [相对路径](相对路径)

**覆盖率状况**:
- ✅ 已覆盖: {{已覆盖的内容}}
- ❌ 未覆盖: {{未覆盖的内容}}

**此错误未能检测的理由**:
{{为什么现有测试未能检测}}

### 必要的测试用例

#### 测试用例1: {{测试名}}
```{{language}}
// 测试的伪代码
test('{{测试名}}', () => {
  // Given: {{前提条件}}
  // When: {{执行内容}}
  // Then: {{期待结果}}
})
```

**目的**: {{此测试验证什么}}

---

## 修正的方向性

### 推荐的修正方法

#### 修正案1: {{修正方法概要}}(推荐)

**变更位置**: [相对路径:行号](相对路径#L行号)

**修正前**:
```{{language}}
{{当前代码}}
```

**修正后**:
```{{language}}
{{修正后的代码案}}
```

**修正说明**:
{{为什么此修正适当}}

**优点**:
- {{优点1}}
- {{优点2}}

**缺点**:
- {{缺点1}}(如有)

**影响范围**:
{{此修正的影响}}

**测试方针**:
{{应如何测试}}

---

#### 修正案2: {{修正方法概要}}(替代案)

(与修正案1同样格式记载)

---

### 应急处置和恒久对策

#### 应急处置(短期)
{{可立即实施的对策}}

#### 恒久对策(长期)
{{根本的解决策}}

---

## 再发防止策

### 代码级别的对策
1. {{对策1}}
2. {{对策2}}
3. {{对策3}}

### 流程级别的对策
1. {{对策1}}(例: 改善审查流程)
2. {{对策2}}(例: 提高测试覆盖率)
3. {{对策3}}(例: 追加lint设置)

### 设计级别的对策
{{如需重新审视设计}}

---

## 参考信息

### 相关文档
- {{相关的文档或规格}}

### 外部参考资料
- {{有参考价值的文章或文档的URL}}

---

*此详细原因分析的结果将在最终报告中总结。*
```

# 分析的注意点

- 特定根本原因需要确实的根据
- 明确区分推测和确实的事实
- 如有多个原因候选请评价确度
- 修正案提示具体的代码例
- **所有文件路径以相对路径记载(不使用绝对路径)**
- **文件目标在500行以内。超过时请分割**

分析完成后,请更新索引文件({{基础目录}}/index.md),启用到详细原因分析的链接。
</root_cause_analysis_template>

<final_report_template>
您是错误原因特定专家。请整合目前为止的所有分析结果,创建综合性的最终报告。

# 报告创建对象的信息

错误概要: {{错误概要}}
分析文件列表: {{分析文件列表}}
最终报告文件名: {{基础目录}}/final_report.md
当前目录: {{当前目录}}

# 重要注意事项

**所有文件路径请以当前目录为基准记载相对路径。**
**请勿使用绝对路径(/Users/... 或 C:\\... 等)。**
**此文件目标在500行以内。**

# 最终报告创建步骤

## 1. 读取全部分析结果

- 用 Read 读取 {{基础目录}}/initial_investigation.md
- 用 Read 读取 {{基础目录}}/flow_analysis.md
- 用 Read 读取 {{基础目录}}/root_cause_analysis.md
- 把握各文件内容,提取重要要点

## 2. 信息整合和摘要创建

- 明确错误的根本原因
- 汇总分析过程中得到的重要发现
- 决定修正方针和优先级
- 制定测试策略

## 3. 创建执行摘要

- 非技术人员也能理解的概要
- 技术详细在别的节说明
- 结论在前,详细在后

## 4. 输出最终报告

请以下列格式将结果输出到文件。使用 Write 工具保存。

```markdown
# 错误原因分析 - 最终报告

**实施日期**: {{实施日期}}
**分析者**: Claude Code

---

## 导航

- [索引](./{filename}_index.md)
- [初始调查](./initial_investigation.md)
- [处理流程分析](./flow_analysis.md)
- [详细原因分析](./root_cause_analysis.md)

---

## 执行摘要

### 错误概要
{{错误的简洁说明}}

### 根本原因
{{用1-2句简洁地说明根本原因}}

### 影响度
**严重度**: 🔴 高 / 🟡 中 / 🟢 低

**影响范围**: {{对哪个功能有影响}}

### 推荐的应对
**优先级**: 🔴 立即应对 / 🟡 尽快应对 / 🟢 计划性应对

**修正工时**: {{概算时间}}

**对发布的影响**: {{是否应延迟发布}}

---

## 错误的详细信息

### 发生条件
{{在什么条件下发生错误}}

### 症状
{{从用户看到的错误症状}}

### 错误信息
{{错误消息或堆栈跟踪(如有)}}

### 重现步骤
1. {{步骤1}}
2. {{步骤2}}
3. {{步骤3}}
4. {{发生错误}}

---

## 分析结果摘要

### 分析过程
1. **初始调查**: {{调查了什么}}
2. **处理流程分析**: {{分析了什么}}
3. **详细原因分析**: {{特定了什么}}

### 主要发现事项

#### 发现1: {{发现内容}}
- **重要度**: 高/中/低
- **详细**: {{详细说明}}
- **参照**: [详细](./{filename}_{{section}}.md)

#### 发现2: {{发现内容}}
(同样格式记载)

---

## 根本原因的详细

### 技术原因

**分类**: {{原因的类别}}(例: null/undefined引用、逻辑错误、异步处理问题等)

**问题位置**: [相对路径:行号](相对路径#L行号)

**问题的代码**:
```{{language}}
{{有问题的代码片段(10-20行)}}
```

**什么是问题**:
{{从技术观点的详细说明}}

**为什么发生错误**:
```
{{逐步说明错误发生的机制}}
1. {{步骤1}}
   ↓
2. {{步骤2}}
   ↓
3. {{发生错误}}
```

### 业务逻辑上的问题
{{如有业务逻辑相关的问题}}

### 设计上的问题
{{如有设计级别的问题}}

---

## 修正方针

### 推荐的修正方法

**概要**: {{用1-2句说明修正概要}}

**变更位置**: [相对路径:行号](相对路径#L行号)

**修正前**:
```{{language}}
{{当前代码}}
```

**修正后**:
```{{language}}
{{修正后的代码}}
```

**修正说明**:
{{为什么此修正适当}}

**变更的影响范围**:
- {{影响1}}
- {{影响2}}
- {{影响3}}

**破坏性变更**: ✅ 有 / ❌ 无

---

### 替代案
{{如有其他修正方法}}

---

## 修正作业的详细

### 实现步骤

1. **{{步骤1}}**
   - 文件: [相对路径](相对路径)
   - 作业内容: {{具体作业}}
   - 所需时间: {{概算}}

2. **{{步骤2}}**
   (同样格式记载)

### 注意点
- {{注意点1}}
- {{注意点2}}
- {{注意点3}}

---

## 测试策略

### 修正的验证方法

#### 手动测试
1. **{{测试用例1}}**
   - 步骤: {{测试步骤}}
   - 期待结果: {{期待的结果}}

2. **{{测试用例2}}**
   (同样格式记载)

#### 自动测试

**应追加的单元测试**:
```{{language}}
// 测试的伪代码
test('{{测试名}}', () => {
  // Given: {{前提条件}}
  // When: {{执行内容}}
  // Then: {{期待结果}}
})
```

**应追加的集成测试**:
{{集成测试的内容}}

**E2E测试**:
{{E2E测试的内容}}

### 回归测试
{{确认对现有功能影响的测试}}

### 测试覆盖率目标
- **变更位置的覆盖率**: {{目标值}}%
- **相关位置的覆盖率**: {{目标值}}%

---

## 影响范围和相关修正

### 直接影响

#### [相对路径:行号](相对路径#L行号)
- **影响内容**: {{有什么样的影响}}
- **必要的修正**: {{是否需要修正}}

### 间接影响

#### [相对路径:行号](相对路径#L行号)
- **影响内容**: {{有什么样的影响}}
- **确认事项**: {{应确认的事}}

### 类似错误的可能性

#### [相对路径:行号](相对路径#L行号)
- **类似度**: 高/中/低
- **确认的必要性**: {{是否应确认}}
- **应对方针**: {{如何应对}}

---

## 再发防止策

### 应立即实施的对策

1. **{{对策1}}**
   - 内容: {{具体对策内容}}
   - 实施者: {{负责人}}
   - 期限: {{期限}}

2. **{{对策2}}**
   (同样格式记载)

### 代码级别的改善

#### lint设置的追加
```{{language}}
// ESLint/TSConfig 等的设置例
{{设置的追加内容}}
```

#### 类型定义的强化
{{TypeScript的类型定义更严格等}}

#### 测试覆盖率的提高
{{覆盖率目标和计划}}

### 流程的改善

#### 代码审查
- {{改善要点1}}
- {{改善要点2}}

#### 测试流程
- {{改善要点1}}
- {{改善要点2}}

#### 文档
- {{改善要点1}}
- {{改善要点2}}

### 设计的重新审视
{{如需设计级别的改善}}

---

## 时间线

### 修正作业的日程

| 阶段 | 作业内容 | 负责 | 期间 | 状态 |
|---------|---------|------|------|------|
| 1 | {{作业1}} | {{负责人}} | {{期间}} | ⏳ 未着手 |
| 2 | {{作业2}} | {{负责人}} | {{期间}} | ⏳ 未着手 |
| 3 | {{作业3}} | {{负责人}} | {{期间}} | ⏳ 未着手 |
| 4 | {{作业4}} | {{负责人}} | {{期间}} | ⏳ 未着手 |

**总所需时间**: {{合计时间}}

---

## 风险和课题

### 已知风险

#### 风险1: {{风险内容}}
- **发生概率**: 高/中/低
- **影响度**: 高/中/低
- **对策**: {{风险减轻策}}

#### 风险2: {{风险内容}}
(同样格式记载)

### 未解决的课题

1. **{{课题1}}**
   - 详细: {{课题的详细}}
   - 应对方针: {{如何应对}}

2. **{{课题2}}**
   (同样格式记载)

---

## 对相关人员的推荐事项

### 对开发团队
- {{推荐事项1}}
- {{推荐事项2}}
- {{推荐事项3}}

### 对QA团队
- {{推荐事项1}}
- {{推荐事项2}}

### 对产品负责人
- {{推荐事项1}}
- {{推荐事项2}}

---

## 附录

### 术语集
- **{{术语1}}**: {{说明}}
- **{{术语2}}**: {{说明}}

### 参考资料
- [{{资料1}}]({{URL}})
- [{{资料2}}]({{URL}})

### 分析文件一览
1. [初始调查](./initial_investigation.md)
2. [处理流程分析](./flow_analysis.md)
3. [详细原因分析](./root_cause_analysis.md)

---

## 结论

{{用2-3段汇总整个分析}}

---

**分析完成日**: {{日期}}
**分析者**: Claude Code
**审查状况**: ⏳ 等待审查

---

*此报告为自动生成。请团队审查内容。*
```

# 报告创建的注意点

- 执行摘要简洁(1页以内)
- 技术详细配置在适当的节
- 提示具体可执行的推荐事项
- 时间线采用现实的估计
- **所有文件路径以相对路径记载(不使用绝对路径)**
- **文件目标在500行以内**

报告创建完成后,请最终更新索引文件({{基础目录}}/index.md),启用到所有分析的链接,并更新快速摘要。
</final_report_template>
