---
description: 实施影响范围分析
allowed-tools: Read, Glob, Grep, Task, Bash
argument-hint: [变更对象(文件路径/函数名/类名/自然语言)]
---
分析变更对象的影响范围,提供需要修改的文件和风险评估。不创建临时文件,直接通过 Task 执行,根据需要进行追加调查,最后创建整体总结。

# context

输出目录=".dcs"
当前目录={{项目根目录}}
分析文件列表=[]

# step

- 如果没有 $1,说"请在参数中指定变更对象(例如:文件路径、函数名、类名或自然语言)"后结束
- 简洁说明 $1 的内容
- 使用 AskUserQuestion 工具依次实施以下问题,并更新 context:
  1. 确认变更对象的类型
  2. 确认变更内容的类型
  3. 确认分析的目的
  4. 确认是否有排除条件
- 向用户宣告收集的 context 内容
- 执行 step2

## step2

- 确认现有输出文件,确定不重复的编号
  - 搜索 {{输出目录}}/{{timestamp}}_*
  - 创建本次内容的简单英语化(例如: "calculate_function", "user_model")
  - 如果存在相同 timestamp 和内容的现有目录,将末尾的序号 +1
  - 基础目录为 "{{输出目录}}/{{timestamp}}_{{内容的英语化}}"
    - 例如: ".dcs/20251008_123456_calculate_function"
    - 例如: ".dcs/20251008_123456_user_model"
- 准备分析结果文件列表(按节分割文件)
  - 索引文件: "{{基础目录}}/index.md"
  - 总结文件: "{{基础目录}}/summary.md"
  - 各层文件: "core.md", "api.md", "service.md", "data.md", "ui.md", "test.md", "config.md", "other.md"
  - 其他: "external.md", "recommendations.md", "details.md"
- 将所有文件名添加到 分析文件列表
- 用 context 信息填充 <impact_analysis_template> 的内容,通过 Task 工具直接执行
  - subagent_type: "general-purpose"
  - description: "影响范围分析的执行"
  - prompt: 用 context 填充模板内容的完整提示
- 接收 Task 的执行结果
- 执行 step3

## step3

- 用 Read 确认输出的文件
- 根据 深入内容规则 判断是否需要追加调查
- 如果需要追加调查:
  - 以列表形式向用户提示追加调查的内容
  - 获得用户的批准
  - 如果有多个追加调查项目,对每个项目分别通过 Task 工具执行追加调查
    - 为每个项目保存为带新序号的追加文件(例如: "2_core.md", "3_api.md", "4_service.md")
    - 将每个文件名添加到 分析文件列表
  - 再次执行 step3(重复直到不需要追加调查,最多5次)
- 如果不需要追加调查:
  - 执行 step4

## step4

- 使用 <summary_template> 的内容,通过 Task 工具创建最终总结文件
  - subagent_type: "general-purpose"
  - description: "影响范围分析 最终总结的创建"
  - prompt: 用 context 填充总结模板内容的完整提示
  - 最终总结文件名: "{{基础目录}}/final_summary.md"
- 按分析次数分类整理并显示所有分析文件的路径
  - 初次分析文件列表(索引、总结、各层文件等)
  - 追加调查文件列表(如适用)
  - 最终总结
- 向用户报告分析完成

# rules

## 确认要点

使用 AskUserQuestion 工具,依次实施以下问题:

### 问题1: 变更对象的类型
- **问题**: 变更对象是哪种类型?
- **header**: "对象类型"
- **options**:
  - "文件路径" - 特定文件整体或文件内的特定位置
  - "函数/方法" - 特定的函数或方法
  - "类/类型" - 类或类型定义
  - "自然语言" - 功能或概念的说明(具体代码元素未特定)

### 问题2: 变更内容的类型
- **问题**: 计划进行什么样的变更?
- **header**: "变更类型"
- **multiSelect**: true
- **options**:
  - "删除" - 删除代码或文件
  - "变更" - 修改现有代码
  - "追加" - 添加新代码或功能
  - "重构" - 不改变行为改进内部实现

### 问题3: 分析的目的
- **问题**: 此影响范围分析的主要目的是什么?
- **header**: "分析目的"
- **options**:
  - "发布前影响确认" - 正式发布前的风险评估
  - "重构计划" - 掌握代码改进的影响范围
  - "Bug修复影响确认" - 确认Bug修复的副作用
  - "功能添加影响确认" - 确认新功能添加对现有功能的影响

### 问题4: 排除条件
- **问题**: 有想从分析中排除的对象吗?
- **header**: "排除条件"
- **multiSelect**: true
- **options**:
  - "测试代码" - 排除测试文件
  - "文档" - 排除文档文件
  - "特定目录" - 排除特定目录(通过追记指定)
  - "不排除" - 全部纳入分析对象

作为context保持以下内容:
- 变更对象(具体的文件路径或代码元素)
- 变更对象的类型
- 变更内容的类型
- 分析的目的
- 排除条件

## 文件名规则

### timestamp 的格式
- yyyyMMddHHmmss 格式(例: 20251008123456)

### 内容英语化的规则
- 将变更对象转换为简洁的英语
- 使用蛇形命名法(snake_case)
- 控制在30字符以内
- 例如:
  - "calculateTotal 関数" → "calculate_total"
  - "用户模型" → "user_model"
  - "src/utils/helper.ts" → "utils_helper"
  - "API端点" → "api_endpoint"

### 按节文件名规则
- 将分析结果按逻辑节分割,每节目标在500行以内
- 每节作为单独文件放在基础目录内
- 节列表:
  - `index.md` - 索引(整体概要和文件列表)
  - `summary.md` - 分析对象和总结
  - `core.md` - 核心逻辑层的影响
  - `api.md` - API层的影响
  - `service.md` - 服务层的影响
  - `data.md` - 数据访问层的影响
  - `ui.md` - UI层的影响
  - `test.md` - 测试的影响
  - `config.md` - 配置的影响
  - `other.md` - 其他影响
  - `external.md` - 外部依赖关系
  - `recommendations.md` - 推荐操作
  - `details.md` - 分析详情

### 追加调查文件名规则
- 如果需要追加调查,为每次追加调查创建新的节文件
- 追加调查添加序号前缀: `2_`, `3_`, `4_` 等
- 例如: `2_core.md`, `2_api.md`, `3_service.md` 等(放在基础目录内)

### 完整文件名示例
**初次分析**:
- `.dcs/20251008123456_calculate_total/index.md` (索引)
- `.dcs/20251008123456_calculate_total/summary.md` (总结)
- `.dcs/20251008123456_calculate_total/core.md` (核心逻辑层)
- `.dcs/20251008123456_calculate_total/api.md` (API层)
- ... (其他节)

**追加调查第1次**:
- `.dcs/20251008123456_calculate_total/2_core.md` (追加调查的核心逻辑层)
- `.dcs/20251008123456_calculate_total/2_api.md` (追加调查的API层)
- ... (其他节)

**最终总结**:
- `.dcs/20251008123456_calculate_total/final_summary.md` (整体总结)

## 文件路径记载规则

- **使用以当前目录为基准的相对路径**
- 不记载完整路径(绝对路径)
- 例如:
  - ❌ `/Users/makotan/projects/esample/src/utils/helper.ts`
  - ✅ `src/utils/helper.ts`
- 当前目录是分析开始时的工作目录
- 所有文件路径统一使用相对路径

## 风险评估标准

从以下观点综合评估风险:

### 影响深度
- 直接引用: 高风险
- 1层间接引用: 中风险
- 2层以上间接引用: 低风险

### 影响范围
- 受影响的文件数多: 风险增加
- 影响有限: 风险降低

### 代码重要度
- 核心逻辑、数据处理: 高风险
- API层、业务逻辑: 中风险
- UI层、显示逻辑: 低风险
- 测试代码: 参考信息

### 变更类型
- 删除、破坏性变更: 高风险
- 类型变更、接口变更: 中风险
- 追加、仅内部实现的变更: 低风险

## 文件类型分类标准

按以下基准分类文件:

- **核心逻辑**: 业务逻辑、数据模型、工具类
- **API层**: 端点、控制器、路由
- **服务层**: 服务类、业务服务
- **数据访问层**: 仓储、DAO、查询
- **UI层**: 组件、视图、模板
- **测试**: 所有测试代码
- **配置**: 配置文件、环境变量
- **其他**: 不属于上述的文件

## 影响类型

- **直接引用**: 通过import/require的直接依赖
- **函数调用**: 函数·方法的直接调用
- **继承**: 类的继承关系
- **实现**: 接口的实现
- **类型依赖**: 对类型定义的依赖
- **间接引用**: 经由中间文件的依赖

## 需要追加调查的条件

符合以下条件之一时,建议追加调查:

- 风险评估为"高"的文件有5个以上
- 存在影响大但详情不明的文件
- 存在复杂的依赖关系的文件(循环引用、多层依赖等)
- 对外部API连接部分有影响
- 与数据库模式相关
- 对配置文件有影响
- 担心对性能的影响
- 分析结果有不明确或模糊的地方

## 深入内容规则

基于调查的内容,从以下观点列出需要追加调查的部分:

- 影响大但详情不明的文件
- 具有复杂依赖关系的文件
- 与外部API连接的部分
- 与数据库模式的关联
- 对配置文件的影响
- 对性能的影响

提出具体的调查内容,参考 originRule 进行深入调查。

## step3 重复规则

- 有需要追加调查的项目时,重复 step3
- 最多重复5次(防止无限循环)
- 有多个追加调查项目时,对每个项目分别执行 Task
- 每次重复创建带新序号的文件
- 获得用户批准后执行下一次调查
- 不需要追加调查时进入 step4

# info

<impact_analysis_template>
你是影响范围分析的专家。基于以下信息,分析变更对象的影响范围,并按节分割输出文件。

# 分析对象信息

变更对象: {{变更对象的具体信息}}
变更内容: {{变更内容的类型}}
分析目的: {{分析的目的}}
排除条件: {{排除条件(如果没有则为"无")}}
基础目录: {{基础目录}}(例: ".dcs/20251008123456_calculate_total")
当前目录: {{当前目录}}

# 重要注意事项

**所有文件路径请以当前目录为基准记载为相对路径。**
**请勿使用绝对路径(/Users/... 或 C:\... 等)。**
**每个节文件请以500行以内为目标。**

例如:
- ❌ `/Users/makotan/projects/esample/src/utils/helper.ts`
- ✅ `src/utils/helper.ts`

# 输出文件构成

将分析结果分割为以下节文件输出:

1. **索引文件**: `{{基础目录}}/index.md`
   - 整体概要和所有节文件的链接

2. **总结文件**: `{{基础目录}}/summary.md`
   - 分析对象、总结、风险评估

3. **各层影响文件**(仅创建有影响的):
   - `{{基础目录}}/core.md` - 核心逻辑层
   - `{{基础目录}}/api.md` - API层
   - `{{基础目录}}/service.md` - 服务层
   - `{{基础目录}}/data.md` - 数据访问层
   - `{{基础目录}}/ui.md` - UI层
   - `{{基础目录}}/test.md` - 测试
   - `{{基础目录}}/config.md` - 配置
   - `{{基础目录}}/other.md` - 其他

4. **其他文件**:
   - `{{基础目录}}/external.md` - 外部依赖关系
   - `{{基础目录}}/recommendations.md` - 推荐操作
   - `{{基础目录}}/details.md` - 分析详情

# 分析步骤

## 1. 特定变更对象

- 如果变更对象是自然语言,用Grep/Glob特定具体的文件·函数·类
- 如果变更对象是文件路径,用 Read 确认该文件的内容
- 如果变更对象是函数/类名,用 Grep 特定定义位置
- 记录特定结果(相对路径、行号、代码元素的类型)

## 2. 分析直接影响

- 使用 Grep 搜索所有直接引用变更对象的位置
  - import/require 语句
  - 函数·方法调用
  - 继承·实现关系
  - 类型定义的使用
- 对每个引用记录以下内容:
  - 相对路径:行号
  - 影响的类型(直接引用、函数调用、继承等)
  - 代码的上下文

## 3. 分析间接影响

- 对每个直接受影响的文件,进一步搜索引用它的文件
- 最多追踪3层(根据需要调整)
- 对每个间接引用记录:
  - 相对路径:行号
  - 影响的类型
  - 影响的深度(第几层)
  - 依赖路径

## 4. 分类文件类型

- 按以下基准对每个受影响的文件进行分类:
  - **核心逻辑**: 业务逻辑、数据模型、工具类
  - **API层**: 端点、控制器、路由
  - **服务层**: 服务类、业务服务
  - **数据访问层**: 仓储、DAO、查询
  - **UI层**: 组件、视图、模板
  - **测试**: 所有测试代码
  - **配置**: 配置文件、环境变量
  - **其他**: 不属于上述的文件
- 从文件路径和目录结构推测
- 根据需要用 Read 确认文件内容

## 5. 评估风险

基于以下基准综合评估每个文件的影响度:

### 影响深度
- 直接引用: 高风险
- 1层间接引用: 中风险
- 2层以上间接引用: 低风险

### 影响范围
- 受影响的文件数多: 风险增加
- 影响有限: 风险降低

### 代码重要度
- 核心逻辑、数据处理: 高风险
- API层、业务逻辑: 中风险
- UI层、显示逻辑: 低风险
- 测试代码: 参考信息

### 变更类型
- 删除、破坏性变更: 高风险
- 类型变更、接口变更: 中风险
- 追加、仅内部实现的变更: 低风险

判定综合风险级别(高/中/低),记录风险评估的依据。

## 6. 确认外部依赖关系

- 确认 package.json、go.mod、requirements.txt 等依赖关系文件
- 调查变更对象影响外部包的可能性
- 作为外部依赖的参考信息记录

## 7. 生成推荐操作

- 基于风险评估,列出应优先确认的文件
- 提示推荐的测试范围
- 记述其他注意事项

## 8. 按节输出文件

按以下顺序创建各节文件。**请使用 Write 工具分别保存每个文件。**

### 8.1 创建索引文件

首先创建 `{{基础目录}}/index.md`。

### 8.2 创建总结文件

然后创建 `{{基础目录}}/summary.md`。

### 8.3 创建各层影响文件

对有影响的文件类型,分别创建单独文件:
- `{{基础目录}}/core.md` - 核心逻辑层(仅在有影响时)
- `{{基础目录}}/api.md` - API层(仅在有影响时)
- `{{基础目录}}/service.md` - 服务层(仅在有影响时)
- `{{基础目录}}/data.md` - 数据访问层(仅在有影响时)
- `{{基础目录}}/ui.md` - UI层(仅在有影响时)
- `{{基础目录}}/test.md` - 测试(仅在有影响时)
- `{{基础目录}}/config.md` - 配置(仅在有影响时)
- `{{基础目录}}/other.md` - 其他(仅在有影响时)

### 8.4 创建其他文件

创建以下文件:
- `{{基础目录}}/external.md` - 外部依赖关系
- `{{基础目录}}/recommendations.md` - 推荐操作
- `{{基础目录}}/details.md` - 分析详情

# 各节文件的输出格式

[由于篇幅限制,此处省略了详细的模板格式,实际文件中包含完整的markdown模板]

# 分析注意点

- 无法检测动态调用(反射、eval等)
- 难以检测通过字符串的间接引用
- 排除被注释掉的代码
- 测试代码作为参考信息包含,但风险评估设为低
- 如有循环引用需注意无限循环,记录已访问的文件
- 将所有受影响的文件作为修改对象提示
- **所有文件路径用相对路径记载(不使用绝对路径)**
- **每个节文件以500行以内为目标。超过500行时进一步细分**

# 输出步骤

**重要**: 请务必按以下顺序创建文件:

1. **首先创建索引文件** (`{{基础目录}}/index.md`)
   - 用 Write 工具保存
   - 包含所有节文件的链接

2. **创建总结文件** (`{{基础目录}}/summary.md`)
   - 用 Write 工具保存

3. **创建有影响的各层文件**(仅有影响的)
   - 用 Write 工具分别保存每个文件
   - 例如: `{{基础目录}}/core.md`, `{{基础目录}}/api.md`, ...

4. **创建其他文件**
   - `{{基础目录}}/external.md`
   - `{{基础目录}}/recommendations.md`
   - `{{基础目录}}/details.md`
   - 用 Write 工具分别保存每个文件

**请使用 Write 工具分别保存每个文件。不要合并成一个文件。**
</impact_analysis_template>

<summary_template>
你是影响范围分析总结创建的专家。基于以下信息,创建整体总结。

# 总结创建对象信息

变更对象: {{变更对象的具体信息}}
分析文件列表: {{分析文件列表}}(索引文件、总结文件、各层文件等)
最终总结文件名: {{总结文件名}}(例: ".dcs/20251008123456_calculate_total/final_summary.md")
当前目录: {{当前目录}}

# 重要注意事项

**所有文件路径请以当前目录为基准记载为相对路径。**
**请勿使用绝对路径(/Users/... 或 C:\... 等)。**
**此文件请简洁记述以控制在500行以内。**

例如:
- ❌ `/Users/makotan/projects/esample/src/utils/helper.ts`
- ✅ `src/utils/helper.ts`

# 总结创建步骤

## 1. 读取全部分析文件

- 用 Read 读取 {{分析文件列表}} 中包含的所有文件
- 把握各文件的内容

## 2. 整合信息

- 从所有分析结果整合以下信息:
  - 受影响的文件总数
  - 综合风险评估(最高风险级别)
  - 最大影响深度
  - 各文件类型的影响数
  - 按优先级的推荐操作数

## 3. 提取要点

- 突出最重要的发现
- 强调特别需要注意的部分
- 记载追加调查中判明的重要事项

## 4. 创建整合推荐操作

- 从所有分析结果提取优先级高的操作
- 排除重复,设定优先顺序
- 提示整体对应方针

## 5. 输出总结文件

以以下输出格式保存结果到 {{总结文件名}}。

[由于篇幅限制,此处省略了详细的markdown模板,实际内容包含完整的总结模板]

# 总结创建注意点

- 全面把握所有分析文件的内容
- 排除重复信息,简洁总结
- 优先记载最重要的信息
- 识别整体趋势和模式
- **所有文件路径用相对路径记载(不使用绝对路径)**

请务必使用 Write 工具保存到 {{总结文件名}}。
</summary_template>
